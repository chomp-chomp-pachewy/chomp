<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chomp Chomp: Recipes & Rituals</title>

  <link rel="icon" type="image/jpeg" href="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Fchomp_recipes_logo.jpeg?alt=media">

  <meta name="title" content="Chomp Chomp Recipes">
  <meta name="description" content="Baking is the materialization of comfort itself.">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

  <style>
    /* --- FILTER SECTION STYLES --- */
    .filter-container {
      display: flex;
      flex-direction: column; /* Stack rows vertically */
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
    }

    /* Row 1: Inputs */
    .filter-row-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      justify-content: center;
      max-width: 800px;
    }

    /* Row 2: Buttons */
    .filter-row-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .recipe-search-box {
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--color-border, #ddd);
      border-radius: 8px;
      background-color: white;
      color: var(--color-text, #333);
      flex: 2; /* Takes up more space */
      min-width: 250px;
    }

    .filter-select {
      padding: 12px 16px; /* Match input height */
      border: 1px solid var(--color-border, #ddd);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      background-color: white;
      color: var(--color-text, #333);
      flex: 1;
      min-width: 150px;
    }

    .btn-search {
        background-color: #333; /* Dark button for Search */
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        font-size: 15px;
    }

    .btn-search:hover { background-color: #000; }

    .btn-clear {
        background-color: transparent;
        color: #666;
        border: 1px solid #ccc;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
    }
    .btn-clear:hover { background-color: #f5f5f5; color: #333; }

    /* Helper for loading state */
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #888;
      font-size: 1.1em;
    }
  </style>
</head>
<body>

  <header class="site-header">
    <nav class="site-nav">
      <div class="header-left">
        <a href="index.html" title="Home" class="site-logo">
          <div class="site-logo-icon">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chomp Chomp" class="logo-default">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704133716_IMG_3433.jpeg?alt=media&token=94d04258-f7c1-4eed-983a-a0eaad6c4f0b" alt="Chomp Chomp" class="logo-hover">
          </div>
        </a>
      </div>

      <div class="header-center">
        <a href="index.html" title="Home">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764781386634_chomp%20recipes%20logo.JPG?alt=media&token=2b7daf1f-2392-493e-944c-512a194327f6"
               alt="Chomp Chomp Recipes"
               class="header-banner">
        </a>
      </div>

      <div class="header-right">
        <div class="nav-tools-dropdown">
          <button class="menu-toggle" onclick="toggleToolsDropdown()">☰</button>
          <button class="tools-dropdown-btn" onclick="toggleToolsDropdown()">Menu ▼</button>
          <ul class="tools-dropdown-menu" id="toolsDropdown">
            <li><a href="index.html">Home</a></li>
            <li><a href="stories.html">Stories</a></li>
            <li><a href="recipes.html" class="active">Recipes</a></li>
            <li><a href="about.html">About</a></li>
            <li class="menu-item-has-submenu">
              <a href="#">Ipsum</a>
              <ul class="submenu">
                <li><a href="tools/dante.html">Inferno</a></li>
                <li><a href="tools/nautical.html">Nautical</a></li>
              </ul>
            </li>
            <li class="menu-item-has-submenu">
              <a href="#">Tools</a>
              <ul class="submenu">
                <li><a href="tools/ip.html">Whois</a></li>
                <li><a href="tools/convert.html">Convert</a></li>
                <li><a href="tools/encode.html">Encode</a></li>
                <li><a href="tools/subnet.html">Subnet</a></li>
                <li><a href="tools/temperature.html">Temperature</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="page-container" style="padding-top: 40px;">

    <section class="content-wrapper text-center mb-xl">
      <h1>Recipes & Rituals</h1>
      <p class="text-muted">Browse, search, and discover your next baking adventure</p>
      <hr style="width: 60px; margin: 30px auto; border: none; border-top: 1px solid var(--color-border, #e0e0e0);">
    </section>

    <section class="content-wrapper">
      <div class="filter-container">
        
        <div class="filter-row-inputs">
            <input type="text"
                   class="recipe-search-box"
                   id="recipeSearch"
                   placeholder="Search recipes by name, ingredient, or keyword...">
            
            <select id="categoryFilter" class="filter-select">
                <option value="all">All Categories</option>
            </select>

            <select id="dishTypeFilter" class="filter-select">
                <option value="all">All Dish Types</option>
            </select>
        </div>

        <div class="filter-row-buttons">
            <button id="searchBtn" class="btn-search">
                Search Recipes
            </button>
            <button id="clearBtn" class="btn-clear">
                Clear Filters
            </button>
        </div>

      </div>
    </section>

    <section class="recipe-grid" id="recipeGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px;">
      
      <div id="loadingMsg" style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">
        <h3>Loading Recipes...</h3>
        <p>Connecting to Chomp Database</p>
      </div>

      <div class="no-results" id="noResults" style="display: none; grid-column: 1 / -1;">
        No recipes found. Try adjusting your filters.
      </div>
    </section>

    <div class="text-center mt-xl" style="margin-top: 40px; margin-bottom: 60px;">
      <button class="btn btn-primary" id="loadMoreBtn" onclick="loadMoreRecipes()" style="display: none;">
        Load More Recipes
      </button>
    </div>

  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>Baking is the materialization of comfort itself.</p>
      <div class="footer-links">
        <a href="mailto:hi@chomp.be">hi@chomp.be</a>
        <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
        <a href="https://chomp.be/tools" target="_blank">chomp chomp: tools</a>
      </div>
      <p style="margin-top: 20px; font-size: 0.85em;">&copy; 2025 Chomp Chomp</p>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId;

    let recipes = [];
    let displayedRecipes = 0;
    const RECIPES_PER_PAGE = 15;

    // --- HELPERS ---
    function generateSlug(title) {
      return title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').trim('-');
    }

    function parseTime(timeString) {
      if (!timeString) return Infinity;
      const rangeMatch = String(timeString).match(/^(\d+)/);
      const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
      const hoursMatch = String(timeString).match(/(\d+)\s*h/);
      const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
      const minutesMatch = String(timeString).match(/(\d+)\s*min/);
      const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
      if (hours + minutes > 0) return hours + minutes;
      else if (rangeMinutes > 0) return rangeMinutes;
      return Infinity;
    }

    function assignDishType(title) {
      const lower = title.toLowerCase();
      if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
      if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
      if (lower.includes('custard')) return 'Frozen Dessert';
      if (lower.includes('pudding')) return 'Pudding/Cream';
      if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish';
      if (lower.includes('soup')) return 'Soup';
      return 'Other Baked Goods';
    }

    function isSafeJson(str) {
      if (typeof str !== 'string') return false;
      str = str.trim();
      return (str.startsWith('{') && str.endsWith('}')) || (str.startsWith('[') && str.endsWith(']'));
    }

    // --- MAIN DATA LOADING ---
    function setupRecipeListener() {
      // Using the path that worked in your test
      const recipesRef = collection(db, `artifacts/${appId}/public/data/recipes`);
      const q = query(recipesRef);

      onSnapshot(q, (snapshot) => {
        recipes = snapshot.docs.map(doc => {
          const data = doc.data();

          if (typeof data.ingredients === 'string' && isSafeJson(data.ingredients)) {
            try { data.ingredients = JSON.parse(data.ingredients); } catch (e) { data.ingredients = []; }
          }
          if (typeof data.source === 'string' && isSafeJson(data.source)) {
            try { data.source = JSON.parse(data.source); } catch (e) { data.source = String(data.source); }
          }

          return {
            ...data,
            slug: data.slug || generateSlug(data.title),
            totalTimeInMinutes: parseTime(data.totalTime || data.cookTime),
            dishType: data.dishType || assignDishType(data.title)
          };
        });

        // Hide loading message
        const loadingMsg = document.getElementById('loadingMsg');
        if(loadingMsg) loadingMsg.style.display = 'none';

        populateFilters();
        applyFiltersAndDisplay();
      }, (error) => {
        console.error("Error loading recipes:", error);
      });
    }

    function populateFilters() {
      const categories = [...new Set(recipes.map(r => r.category).filter(c => c))].sort();
      const dishTypes = [...new Set(recipes.map(r => r.dishType).filter(d => d))].sort();

      const categoryFilter = document.getElementById('categoryFilter');
      const dishTypeFilter = document.getElementById('dishTypeFilter');

      categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');

      dishTypeFilter.innerHTML = '<option value="all">All Dish Types</option>' +
        dishTypes.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // --- FILTER LOGIC (Updated: Removed SortBy) ---
    function applyFiltersAndDisplay() {
      const searchTerm = document.getElementById('recipeSearch').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const dishType = document.getElementById('dishTypeFilter').value;
      // removed sortBy variable

      // Filter
      let filtered = recipes.filter(r => {
        const matchesSearch = !searchTerm ||
          r.title.toLowerCase().includes(searchTerm) ||
          (r.description && r.description.toLowerCase().includes(searchTerm)) ||
          (Array.isArray(r.ingredients) && r.ingredients.some(i => i.toLowerCase().includes(searchTerm)));

        const matchesCategory = category === 'all' || r.category === category;
        const matchesDishType = dishType === 'all' || r.dishType === dishType;

        return matchesSearch && matchesCategory && matchesDishType;
      });

      // Default Sort: Alphabetical
      filtered.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));

      displayRecipes(filtered);
    }

    function displayRecipes(recipesToShow) {
      const grid = document.getElementById('recipeGrid');
      const noResults = document.getElementById('noResults');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      // Clear existing cards (manual clear so we don't kill hidden divs)
      Array.from(grid.children).forEach(child => {
          if (child.id !== 'loadingMsg' && child.id !== 'noResults') child.remove();
      });

      if (recipesToShow.length === 0) {
        noResults.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        return;
      }

      noResults.style.display = 'none';
      displayedRecipes = Math.min(RECIPES_PER_PAGE, recipesToShow.length);

      const cardsHTML = recipesToShow.slice(0, displayedRecipes).map(recipe => {
        const timeText = recipe.totalTimeInMinutes === Infinity ? 'Time N/A' : `${recipe.totalTimeInMinutes} min`;
        const imagePath = recipe.image
          ? (recipe.image.startsWith('http') ? recipe.image : `images/${recipe.image}`)
          : null;

        return `
          <article class="recipe-card" style="border:1px solid #eee; border-radius:8px; overflow:hidden; cursor:pointer;" onclick="window.location.href='recipe.html?slug=${recipe.slug}'">
            ${imagePath
              ? `<img src="${imagePath}" alt="${recipe.title}" style="width:100%; height:200px; object-fit:cover;">`
              : `<div style="width:100%; height:200px; background:#f5f5f5; display:flex; align-items:center; justify-content:center; color:#999;">No Image Available</div>`
            }
            <div class="recipe-card-content" style="padding:15px;">
              <h3 class="recipe-card-title" style="margin:0 0 10px 0; font-size:1.1em;">${recipe.title}</h3>
              <p style="font-size:0.9em; color:#666; margin-bottom:15px;">
                 ${recipe.description ? recipe.description.substring(0, 100) + '...' : ''}
              </
