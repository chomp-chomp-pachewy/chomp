<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chomp Chomp: Recipes & Rituals</title>

  <!-- Primary favicon -->
  <link rel="icon" href="/favicon.ico" sizes="any">

  <!-- PNG favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

  <!-- Apple iOS home screen -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Web App Manifest (Android / PWA) -->
  <link rel="manifest" href="/site.webmanifest">

  <!-- Theme color for mobile browsers -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a1a">

  <!-- iOS web app behavior (optional but recommended) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Chomp Chomp">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Primary Meta Tags -->
  <meta name="title" content="Chomp Chomp Recipes">
  <meta name="description" content="Baking is the materialization of comfort itself.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://chomp.be/">
  <meta property="og:title" content="Chomp Chomp Recipes">
  <meta property="og:description" content="Baking is the materialization of comfort itself.">
  <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764743197557_IMG_3460.jpeg?alt=media&token=ead0f58a-8584-48a8-b1ed-ac29962d5c3e">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://chomp.be/">
  <meta property="twitter:title" content="Chomp Chomp Recipes">
  <meta property="twitter:description" content="Baking is the materialization of comfort itself.">
  <meta property="twitter:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764743197557_IMG_3460.jpeg?alt=media&token=ead0f58a-8584-48a8-b1ed-ac29962d5c3e">

  <!-- Open Graph / Social Media Preview Tags -->
  <meta property="og:title" content="Chomp Chomp: Recipes & Rituals">
  <meta property="og:description" content="Browse our complete collection of baking recipes and culinary rituals.">
  <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Fchomp_recipes.png?alt=media">
  <meta property="og:url" content="https://chomp.be/recipes.html">
  <meta property="og:type" content="website">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Shared Stylesheet -->
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Additional recipe-specific styles */
    .recipe-search-box {
      width: 100%;
      max-width: 500px;
      margin: 0 auto 30px auto;
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background-color: white;
      color: var(--color-text);
    }

    .recipe-search-box:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      background-color: white;
      color: var(--color-text);
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--color-text-muted);
      font-size: 1.1em;
    }

    /* Recipe count with fade animation */
    #recipeCount {
      margin-bottom: 15px;
      color: var(--color-text-muted);
      font-size: 0.9em;
      text-align: center;
      display: none;
      opacity: 1;
      transition: opacity 0.25s ease-in-out;
    }

    #recipeCount.fade-out {
      opacity: 0;
    }
  </style>
</head>
<body>

  <!-- Site Header / Navigation -->
  <header class="site-header">
    <nav class="site-nav">
      <div class="header-left">
        <a href="https://chomp.be" title="Home" class="site-logo">
          <div class="site-logo-icon">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chomp Chomp" class="logo-default">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704133716_IMG_3433.jpeg?alt=media&token=94d04258-f7c1-4eed-983a-a0eaad6c4f0b" alt="Chomp Chomp" class="logo-hover">
          </div>
        </a>
      </div>

      <div class="header-center">
        <a href="index.html" title="Home">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764781386634_chomp%20recipes%20logo.JPG?alt=media&token=2b7daf1f-2392-493e-944c-512a194327f6"
               alt="Chomp Chomp Recipes"
               class="header-banner">
        </a>
      </div>

      <div class="header-right">
        <div class="nav-tools-dropdown">
          <button class="menu-toggle" onclick="toggleToolsDropdown()">☰</button>
          <button class="tools-dropdown-btn" onclick="toggleToolsDropdown()">Menu ▼</button>
          <ul class="tools-dropdown-menu" id="toolsDropdown">
            <li><a href="index.html">Home</a></li>
            <li><a href="stories.html">Stories</a></li>
            <li><a href="recipes.html" class="active">Recipes</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="store.html">Store</a></li>
            <li class="menu-item-has-submenu">
              <a href="#">Tools</a>
              <ul class="submenu">
                <li><a href="tools/index.html">Index</a></li>
                <li><a href="tools/ip.html">Whois</a></li>
                <li><a href="tools/weather.html">Weather</a></li>
                <li><a href="tools/convert.html">Convert</a></li>
                <li><a href="tools/encode.html">Encode</a></li>
                <li><a href="tools/subnet.html">Subnet</a></li>
              </ul>
            </li>
            <li class="menu-item-has-submenu">
              <a href="#">Ipsum</a>
              <ul class="submenu">
                <li><a href="tools/dante.html">Inferno</a></li>
                <li><a href="tools/nautical.html">Nautical</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="page-container">

    <!-- Page Title -->
    <section class="content-wrapper text-center mb-xl">
      <h1>Recipes & Rituals</h1>
      <p class="text-muted">Browse, search, and discover your next baking adventure</p>

      <hr style="width: 60px; margin: 30px auto; border: none; border-top: 1px solid var(--color-border, #e0e0e0);">

      <a href="index.html" style="color: var(--color-accent, #e73b42); text-decoration: none; font-size: 0.95em; transition: opacity 0.2s; display: inline-block;"
         onmouseover="this.style.opacity='0.7'"
         onmouseout="this.style.opacity='1'">
        Go to Stories & Meditations →
      </a>
    </section>

    <!-- Search & Filter Controls -->
    <section class="content-wrapper">
      <div class="filter-controls">
        <input type="text"
               class="recipe-search-box"
               id="recipeSearch"
               placeholder="Search recipes by name, ingredient, or keyword..."
               style="flex: 1; min-width: 200px; max-width: 500px; margin: 0;">

        <select id="categoryFilter">
          <option value="all">All Categories</option>
          <!-- Categories will be populated dynamically -->
        </select>

        <select id="dishTypeFilter">
          <option value="all">All Dish Types</option>
          <!-- Dish types will be populated dynamically -->
        </select>

        <select id="sortBy">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="time">Sort: Quickest Time</option>
        </select>

        <button class="btn btn-outline" id="searchBtn">Search Recipes</button>
        <button class="btn btn-outline" id="clearBtn">Clear Filters</button>
      </div>
    </section>

    <!-- Recipe Count -->
    <div id="recipeCount"></div>

    <!-- Recipe Grid -->
    <section class="recipe-grid" id="recipeGrid">
      <div class="no-results" id="noResults" style="display: none; grid-column: 1 / -1;">
        No recipes found. Try adjusting your filters.
      </div>
    </section>

    <!-- Load More Button -->
    <div class="text-center mt-xl">
      <button class="btn btn-primary" id="loadMoreBtn" style="display: none;">
        Load More Recipes
      </button>
    </div>

  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <p>Baking is the materialization of comfort itself.</p>
      <div class="footer-links">
        <a href="mailto:hi@chomp.be">hi@chomp.be</a>
        <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
        <a href="https://chomp.be/tools" target="_blank">chomp chomp: tools</a>
      </div>
      <p style="margin-top: 20px; font-size: 0.85em;">&copy; 2025 Chomp Chomp</p>
    </div>
  </footer>

  <!-- Firebase SDK and Recipe Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId;

    let recipes = [];
    let displayedRecipes = 0;
    const RECIPES_PER_PAGE = 15;

    // Helper: Generate slug from title
    function generateSlug(title) {
      return String(title || '')
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    }

    // Helper: Parse time strings
    function parseTime(timeString) {
      if (!timeString) return Infinity;
      const rangeMatch = String(timeString).match(/^(\d+)/);
      const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
      const hoursMatch = String(timeString).match(/(\d+)\s*h/);
      const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
      const minutesMatch = String(timeString).match(/(\d+)\s*min/);
      const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;

      if (hours + minutes > 0) return hours + minutes;
      else if (rangeMinutes > 0) return rangeMinutes;
      return Infinity;
    }

    // Helper: Assign dish type based on title
    function assignDishType(title) {
      const lower = String(title || '').toLowerCase();
      if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
      if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
      if (lower.includes('custard')) return 'Frozen Dessert';
      if (lower.includes('pudding')) return 'Pudding/Cream';
      if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish';
      if (lower.includes('soup')) return 'Soup';
      return 'Other Baked Goods';
    }

    // Helper: Check if string is JSON
    function isSafeJson(str) {
      if (typeof str !== 'string') return false;
      str = str.trim();
      return (str.startsWith('{') && str.endsWith('}')) || (str.startsWith('[') && str.endsWith(']'));
    }

    // Recipe count with fade animation
    function updateRecipeCount(filteredCount, totalCount) {
      const el = document.getElementById('recipeCount');
      if (!el) return;

      if (totalCount === 0) {
        el.style.display = 'none';
        return;
      }

      // First time: no fade, just set
      if (el.style.display === 'none' || el.textContent === '') {
        el.textContent = `Showing ${filteredCount} of ${totalCount} recipes`;
        el.style.display = 'block';
        return;
      }

      // Fade out -> change text -> fade in
      el.classList.add('fade-out');

      setTimeout(() => {
        el.textContent = `Showing ${filteredCount} of ${totalCount} recipes`;
        el.classList.remove('fade-out');
      }, 250); // match CSS transition
    }

    // Load recipes from Firestore (live updates)
    function setupRecipeListener() {
      const recipesRef = collection(db, `artifacts/${appId}/public/data/recipes`);
      const q = query(recipesRef);

      onSnapshot(q, (snapshot) => {
        recipes = snapshot.docs.map(doc => {
          const data = doc.data() || {};

          // Parse serialized JSON fields
          if (typeof data.ingredients === 'string' && isSafeJson(data.ingredients)) {
            try { data.ingredients = JSON.parse(data.ingredients); }
            catch (e) { data.ingredients = []; }
          }

          if (typeof data.source === 'string' && isSafeJson(data.source)) {
            try { data.source = JSON.parse(data.source); }
            catch (e) { data.source = String(data.source); }
          }

          return {
            ...data,
            slug: data.slug || generateSlug(data.title),
            totalTimeInMinutes: parseTime(data.totalTime || data.cookTime),
            dishType: data.dishType || assignDishType(data.title)
          };
        });

        populateFilters();
        applyFiltersAndDisplay(); // will call updateRecipeCount
      }, (error) => {
        console.error("Error loading recipes:", error);
        const noResults = document.getElementById('noResults');
        if (noResults) {
          noResults.style.display = 'block';
          noResults.textContent = 'Failed to load recipes. Please check your connection.';
        }
      });
    }

    // Populate filter dropdowns
    function populateFilters() {
      const categories = [...new Set(recipes.map(r => r.category).filter(c => c))].sort();
      const dishTypes = [...new Set(recipes.map(r => r.dishType).filter(d => d))].sort();

      const categoryFilter = document.getElementById('categoryFilter');
      const dishTypeFilter = document.getElementById('dishTypeFilter');

      if (!categoryFilter || !dishTypeFilter) return;

      categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');

      dishTypeFilter.innerHTML = '<option value="all">All Dish Types</option>' +
        dishTypes.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // Apply filters and sort, then display
    function applyFiltersAndDisplay() {
      const searchInput = document.getElementById('recipeSearch');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');

      if (!searchInput || !categorySelect || !dishTypeSelect || !sortSelect) return;

      const searchTerm = searchInput.value.toLowerCase();
      const category = categorySelect.value;
      const dishType = dishTypeSelect.value;
      const sortBy = sortSelect.value;

      let filtered = recipes.filter(r => {
        const title = String(r.title || '').toLowerCase();
        const description = String(r.description || '').toLowerCase();

        const matchesSearch =
          !searchTerm ||
          title.includes(searchTerm) ||
          description.includes(searchTerm) ||
          (
            Array.isArray(r.ingredients) &&
            r.ingredients.some(i =>
              typeof i === 'string' &&
              i.toLowerCase().includes(searchTerm)
            )
          );

        const matchesCategory = category === 'all' || r.category === category;
        const matchesDishType = dishType === 'all' || r.dishType === dishType;

        return matchesSearch && matchesCategory && matchesDishType;
      });

      // Sort recipes
      if (sortBy === 'time') {
        filtered.sort((a, b) => (a.totalTimeInMinutes || Infinity) - (b.totalTimeInMinutes || Infinity));
      } else {
        filtered.sort((a, b) =>
          String(a.title || '').toLowerCase().localeCompare(String(b.title || '').toLowerCase())
        );
      }

      // Update count + display
      updateRecipeCount(filtered.length, recipes.length);
      displayRecipes(filtered);
    }

    // Display recipes in grid
    function displayRecipes(recipesToShow) {
      const grid = document.getElementById('recipeGrid');
      const noResults = document.getElementById('noResults');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      if (!grid) return;

      if (!recipesToShow || recipesToShow.length === 0) {
        grid.innerHTML = '';
        if (noResults) noResults.style.display = 'block';
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
      }

      if (noResults) noResults.style.display = 'none';
      
// Only set the initial page size the first time,
// otherwise just clamp it so it never goes past the list length
if (displayedRecipes === 0) {
  displayedRecipes = Math.min(RECIPES_PER_PAGE, recipesToShow.length);
} else {
  displayedRecipes = Math.min(displayedRecipes, recipesToShow.length);
}
      
      grid.innerHTML = recipesToShow.slice(0, displayedRecipes).map(recipe => {
        const timeText = recipe.totalTimeInMinutes === Infinity || recipe.totalTimeInMinutes == null
          ? 'Time N/A'
          : `${recipe.totalTimeInMinutes} min`;
        const imagePath = recipe.image
          ? (recipe.image.startsWith('http') ? recipe.image : `images/${recipe.image}`)
          : null;

        return `
          <article class="recipe-card" onclick="window.location.href='recipe.html?slug=${recipe.slug}'">
            ${imagePath
              ? `<img src="${imagePath}" alt="${recipe.title}" class="recipe-card-image">`
              : '<div class="post-tile-placeholder">No Image Available</div>'
            }
            <div class="recipe-card-content">
              <h3 class="recipe-card-title">${recipe.title}</h3>
              <p class="card-description" style="font-size: 0.9em; color: var(--color-text-muted); margin: 8px 0;">
                ${recipe.description ? recipe.description.substring(0, 100) + '...' : 'A delicious recipe waiting to be made!'}
              </p>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px; font-size: 0.85em; color: var(--color-text-muted);">
                <span style="color: var(--color-accent); font-weight: 500;">${recipe.dishType || 'Recipe'}</span>
                <span>${timeText}</span>
              </div>
            </div>
          </article>
        `;
      }).join('');

      if (loadMoreBtn) {
        loadMoreBtn.style.display = displayedRecipes < recipesToShow.length ? 'inline-block' : 'none';
      }

      window.currentFilteredRecipes = recipesToShow;
    }

    // Load more recipes
    window.loadMoreRecipes = function() {
      const recipesToShow = window.currentFilteredRecipes || recipes;
      displayedRecipes += RECIPES_PER_PAGE;
      displayRecipes(recipesToShow);
    }

    // Clear all filters and re-run
    function clearFilters() {
      const searchInput = document.getElementById('recipeSearch');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');

      if (searchInput) searchInput.value = '';
      if (categorySelect) categorySelect.value = 'all';
      if (dishTypeSelect) dishTypeSelect.value = 'all';
      if (sortSelect) sortSelect.value = 'alphabetical';

      applyFiltersAndDisplay();
    }

    // --- EVENT LISTENERS (DIALED BACK) ---
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('recipeSearch');
      const searchBtn = document.getElementById('searchBtn');
      const clearBtn = document.getElementById('clearBtn');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      if (searchBtn) {
        searchBtn.addEventListener('click', applyFiltersAndDisplay);
      }

      // Enter key in search box
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            applyFiltersAndDisplay();
          }
        });
      }

      // Category / dish type / sort changes filter immediately
      if (categorySelect) {
        categorySelect.addEventListener('change', applyFiltersAndDisplay);
      }
      if (dishTypeSelect) {
        dishTypeSelect.addEventListener('change', applyFiltersAndDisplay);
      }
      if (sortSelect) {
        sortSelect.addEventListener('change', applyFiltersAndDisplay);
      }

if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', () => {
      if (window.loadMoreRecipes) {
        window.loadMoreRecipes();
      }
    });
  }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', clearFilters);
      }
    });

    // Initialize
    setupRecipeListener();
  </script>

  <!-- Navigation toggle -->
  <script>
    function toggleToolsDropdown() {
      const dropdown = document.getElementById('toolsDropdown');
      dropdown.classList.toggle('active');
    }
  </script>

</body>
</html>
