<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chomp Chomp Recipes – Recipe Index</title>
  <meta name="description" content="Browse all recipes from Chomp Chomp: cookies, biscuits, and baking rituals. Filter, search, and discover your next baking project.">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-bg: #fdfdfd;
      --color-bg-alt: #ffffff;
      --color-text: #434343;
      --color-text-muted: #7a7a7a;
      --color-accent: #ea7480;
      --color-border: #e0e0e0;
      --color-header-bg: #ffffff;
      --color-footer-bg: #f5f5f5;
      --color-card-bg: #ffffff;
      --color-chip-bg: #f1f1f1;
      --color-chip-border: #e0e0e0;

      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.06);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;

      --transition-fast: 0.15s ease-out;

      --max-width: 1100px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #111111;
        --color-bg-alt: #161616;
        --color-text: #f5f5f5;
        --color-text-muted: #b3b3b3;
        --color-accent: #ea7480;
        --color-border: #333333;
        --color-header-bg: #111111;
        --color-footer-bg: #111111;
        --color-card-bg: #181818;
        --color-chip-bg: #1f1f1f;
        --color-chip-border: #333333;

        --shadow-soft: 0 6px 18px rgba(0, 0, 0, 0.5);
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: var(--color-accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .page-shell {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 0 var(--spacing-md) var(--spacing-xl);
    }

    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background-color: var(--color-header-bg);
      border-bottom: 1px solid var(--color-border);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 20px var(--spacing-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
    }

    .site-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      text-decoration: none;
      color: inherit;
    }

    .site-logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      flex-shrink: 0;
    }

    .site-logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .site-logo-title {
      font-weight: 700;
      letter-spacing: -0.03em;
      font-size: 1.15rem;
    }

    .site-logo-subtitle {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .site-nav {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .nav-links {
      display: flex;
      gap: var(--spacing-md);
      font-size: 0.9rem;
    }

    .nav-links a {
      color: var(--color-text-muted);
      text-decoration: none;
      position: relative;
      padding-bottom: 2px;
    }

    .nav-links a:hover {
      color: var(--color-text);
    }

    .nav-links a.active {
      color: var(--color-accent);
      font-weight: 500;
    }

    .nav-links a.active::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 2px;
      background: var(--color-accent);
      border-radius: 999px;
    }

    .header-tools {
      position: relative;
    }

    .tools-dropdown-btn {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background-color: var(--color-bg-alt);
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--color-text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tools-dropdown {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background-color: var(--color-card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-soft);
      padding: 10px;
      min-width: 180px;
      display: none;
      z-index: 60;
    }

    .tools-dropdown.active {
      display: block;
    }

    .tools-dropdown a {
      display: block;
      font-size: 0.85rem;
      padding: 6px 8px;
      color: var(--color-text-muted);
      border-radius: var(--radius-sm);
    }

    .tools-dropdown a:hover {
      background-color: var(--color-chip-bg);
      color: var(--color-text);
      text-decoration: none;
    }

    .menu-toggle {
      display: none;
      border: none;
      background: transparent;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--color-text);
    }

    @media (max-width: 720px) {
      .nav-links {
        display: none;
      }
      .menu-toggle {
        display: inline-flex;
      }
      .tools-dropdown-btn {
        display: none;
      }
    }

    main {
      margin-top: var(--spacing-lg);
    }

    .page-header {
      margin-bottom: var(--spacing-lg);
    }

    .page-kicker {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--color-text-muted);
      margin-bottom: 6px;
    }

    .page-title {
      font-size: 1.8rem;
      letter-spacing: -0.03em;
      margin-bottom: var(--spacing-sm);
    }

    .page-subtitle {
      color: var(--color-text-muted);
      font-size: 0.95rem;
      max-width: 620px;
    }

    .filter-panel {
      display: grid;
      grid-template-columns: minmax(0, 2fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    @media (min-width: 720px) {
      .filter-panel {
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      }
    }

    .filter-search {
      display: flex;
      gap: 8px;
    }

    .filter-search input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background-color: var(--color-bg-alt);
      color: var(--color-text);
      font-size: 0.9rem;
    }

    .filter-search input::placeholder {
      color: var(--color-text-muted);
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
    }

    .filter-group select {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background-color: var(--color-bg-alt);
      color: var(--color-text);
      font-size: 0.85rem;
      min-width: 150px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid transparent;
      white-space: nowrap;
      transition: background-color var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast), transform 0.1s ease-out;
    }

    .btn-primary {
      background-color: var(--color-accent);
      color: #ffffff;
      border-color: var(--color-accent);
      box-shadow: 0 8px 18px rgba(234, 116, 128, 0.35);
    }

    .btn-primary:hover {
      background-color: #d8616f;
      border-color: #d8616f;
      box-shadow: 0 10px 22px rgba(234, 116, 128, 0.45);
      transform: translateY(-1px);
    }

    .btn-outline {
      background-color: transparent;
      border-color: var(--color-border);
      color: var(--color-text-muted);
    }

    .btn-outline:hover {
      background-color: var(--color-chip-bg);
      color: var(--color-text);
      border-color: var(--color-border);
    }

    .btn-ghost {
      background-color: transparent;
      border-color: transparent;
      color: var(--color-text);
      padding-left: 0;
    }

    .btn-ghost:hover {
      color: var(--color-accent);
      background-color: transparent;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: var(--color-chip-bg);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      color: var(--color-text-muted);
      border: 1px solid var(--color-chip-border);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--color-accent);
    }

    .recipe-count-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: var(--spacing-md) 0 var(--spacing-sm);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }

    .recipe-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    @media (min-width: 600px) {
      .recipe-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 960px) {
      .recipe-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .recipe-card {
      background-color: var(--color-card-bg);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      cursor: pointer;
      min-height: 100%;
      border: 1px solid rgba(0, 0, 0, 0.02);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out;
    }

    .recipe-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
      border-color: rgba(234, 116, 128, 0.4);
    }

    .recipe-card-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    @media (min-width: 960px) {
      .recipe-card-image {
        height: 170px;
      }
    }

    .post-tile-placeholder {
      width: 100%;
      height: 150px;
      background: repeating-linear-gradient(
        -45deg,
        #f2f2f2,
        #f2f2f2 10px,
        #e5e5e5 10px,
        #e5e5e5 20px
      );
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    @media (prefers-color-scheme: dark) {
      .post-tile-placeholder {
        background: repeating-linear-gradient(
          -45deg,
          #1e1e1e,
          #1e1e1e 10px,
          #252525 10px,
          #252525 20px
        );
        color: var(--color-text-muted);
      }
    }

    .recipe-card-content {
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .recipe-card-title {
      font-size: 1rem;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .recipe-meta {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .recipe-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .recipe-meta .dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background-color: var(--color-text-muted);
    }

    .no-results {
      text-align: center;
      padding: var(--spacing-lg) var(--spacing-md);
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }

    .text-center {
      text-align: center;
    }

    .mt-xl {
      margin-top: var(--spacing-xl);
    }

    .site-footer {
      border-top: 1px solid var(--color-border);
      background-color: var(--color-footer-bg);
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg) var(--spacing-md) var(--spacing-xl);
    }

    .footer-content {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
    }

    .footer-links a {
      color: var(--color-text-muted);
    }

    .footer-links a:hover {
      color: var(--color-accent);
    }

    .recipe-count-summary {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .recipe-count-summary strong {
      color: var(--color-text);
    }

    .recipe-count-summary span {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .active-filter-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .active-filter-badges .pill {
      background-color: transparent;
      border-style: dashed;
    }

    .active-filter-badges .pill-label {
      font-weight: 500;
      color: var(--color-text);
    }

    .helper-text {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="site-logo">
        <div class="site-logo-icon">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/chomp_recipes.png?alt=media" alt="Chomp Chomp logo">
        </div>
        <div class="site-logo-text">
          <span class="site-logo-title">chomp chomp recipes</span>
          <span class="site-logo-subtitle">cookies, biscuits, and the rituals around them</span>
        </div>
      </a>

      <nav class="site-nav">
        <button class="menu-toggle">☰</button>
        <div class="nav-links">
          <a href="/" class="active">Recipes</a>
          <a href="https://www.chomp.ltd" target="_blank">Baking Manifesto</a>
          <a href="https://chomp.be" target="_blank">Tools</a>
        </div>
        <div class="header-tools">
          <button class="tools-dropdown-btn">Menu ▼</button>
          <div class="tools-dropdown" id="toolsDropdown">
            <a href="https://chomp.be/tools" target="_blank">Baking Tools &amp; Calculators</a>
            <a href="https://chomp.be/your-ip" target="_blank">Your IP Address</a>
            <a href="https://chomp.be/subnet" target="_blank">Subnet &amp; CIDR Calculator</a>
            <a href="https://chomp.be/encode" target="_blank">Encoding Tools</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="page-shell">
    <section class="page-header">
      <div class="page-kicker">Recipe Index</div>
      <h1 class="page-title">All Recipes</h1>
      <p class="page-subtitle">
        Browse every recipe from Chomp Chomp: cookies, biscuits, bars, and the occasional cake. Use the filters below
        to find something by category, dish type, or total time.
      </p>
    </section>

    <section class="filter-panel">
      <div class="filter-search">
        <input
          type="search"
          id="recipeSearch"
          placeholder="Search by recipe name, description, or ingredient…"
          aria-label="Search recipes"
        />
        <button class="btn btn-outline" id="searchBtn">Search</button>
      </div>

      <div class="filter-group">
        <select id="categoryFilter" aria-label="Filter by category">
          <option value="all">All Categories</option>
          <option value="biscuit">Biscuits / Cookies</option>
          <option value="bar">Bars &amp; Traybakes</option>
          <option value="cake">Cakes &amp; Tortes</option>
          <option value="other">Other / Miscellaneous</option>
        </select>

        <select id="dishTypeFilter" aria-label="Filter by dish type">
          <option value="all">All Dish Types</option>
          <option value="shortbread">Shortbread</option>
          <option value="sablé">Sablé</option>
          <option value="sandwich">Sandwich Cookie</option>
          <option value="biscotti">Biscotti</option>
          <option value="bar">Bar</option>
          <option value="cake">Cake</option>
        </select>

        <select id="sortBy" aria-label="Sort recipes">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="time">Sort: Quickest Time</option>
        </select>

        <button class="btn btn-outline" id="clearBtn">Clear Filters</button>
      </div>
    </section>

    <div class="recipe-count-bar">
      <div class="recipe-count-summary">
        <span class="pill">
          <span class="pill-dot"></span>
          <span id="recipeCount">Loading recipes…</span>
        </span>
      </div>
      <div class="active-filter-badges" id="activeFilters"></div>
    </div>

    <section class="recipe-grid" id="recipeGrid">
      <div class="no-results" id="noResults" style="display: none; grid-column: 1 / -1;">
        No recipes found. Try adjusting your filters.
      </div>
    </section>

    <div class="text-center mt-xl">
      <button class="btn btn-primary" id="loadMoreBtn" style="display: none;">
        Load More Recipes
      </button>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>Baking is the materialization of comfort itself.</p>
      <div class="footer-links">
        <a href="mailto:hi@chomp.be">hi@chomp.be</a>
        <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
        <a href="https://chomp.be/tools" target="_blank">baking tools &amp; calculators</a>
      </div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let recipes = [];
    let displayedRecipes = 0;
    const RECIPES_PER_PAGE = 15;

    function mapRecipe(doc) {
      const data = doc.data() || {};
      const prep = Number(data.prepTimeInMinutes || 0);
      const cook = Number(data.cookTimeInMinutes || 0);
      const totalTime = prep + cook;

      return {
        id: doc.id,
        title: data.title || "Untitled Recipe",
        slug: data.slug || doc.id,
        description: data.description || "",
        category: data.category || "other",
        dishType: data.dishType || "",
        prepTimeInMinutes: isFinite(prep) ? prep : null,
        cookTimeInMinutes: isFinite(cook) ? cook : null,
        totalTimeInMinutes: isFinite(totalTime) && totalTime > 0 ? totalTime : Infinity,
        image: data.image || "",
        isPlaceholder: !!data.isPlaceholder
      };
    }

    function updateRecipeCount(filteredCount, totalCount) {
      const recipeCountEl = document.getElementById('recipeCount');
      const activeFiltersEl = document.getElementById('activeFilters');

      if (!recipeCountEl) return;

      if (!recipes.length) {
        recipeCountEl.textContent = 'Loading recipes…';
        if (activeFiltersEl) activeFiltersEl.innerHTML = '';
        return;
      }

      if (filteredCount === totalCount) {
        recipeCountEl.textContent = `${totalCount} recipe${totalCount !== 1 ? 's' : ''} total`;
      } else {
        recipeCountEl.textContent = `${filteredCount} of ${totalCount} recipes`;
      }

      const searchInput = document.getElementById('recipeSearch');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');

      const activeFilters = [];

      if (searchInput && searchInput.value.trim().length > 0) {
        activeFilters.push({ label: 'Search', value: searchInput.value.trim() });
      }
      if (categorySelect && categorySelect.value !== 'all') {
        activeFilters.push({ label: 'Category', value: categorySelect.options[categorySelect.selectedIndex].textContent });
      }
      if (dishTypeSelect && dishTypeSelect.value !== 'all') {
        activeFilters.push({ label: 'Dish Type', value: dishTypeSelect.options[dishTypeSelect.selectedIndex].textContent });
      }
      if (sortSelect && sortSelect.value !== 'alphabetical') {
        activeFilters.push({ label: 'Sort', value: sortSelect.options[sortSelect.selectedIndex].textContent });
      }

      if (!activeFiltersEl) return;

      if (!activeFilters.length) {
        activeFiltersEl.innerHTML = '';
        return;
      }

      activeFiltersEl.innerHTML = activeFilters.map(filter => `
        <div class="pill">
          <span class="pill-label">${filter.label}:</span>
          <span>${filter.value}</span>
        </div>
      `).join('');
    }

    function displayRecipes(recipesToShow) {
      const grid = document.getElementById('recipeGrid');
      const noResults = document.getElementById('noResults');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      if (!grid) return;

      if (!recipesToShow || recipesToShow.length === 0) {
        grid.innerHTML = '';
        if (noResults) noResults.style.display = 'block';
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
      }

      if (noResults) noResults.style.display = 'none';

      // Initialize or clamp how many recipes are shown
      if (displayedRecipes === 0) {
        displayedRecipes = Math.min(RECIPES_PER_PAGE, recipesToShow.length);
      } else {
        displayedRecipes = Math.min(displayedRecipes, recipesToShow.length);
      }

      grid.innerHTML = recipesToShow.slice(0, displayedRecipes).map(recipe => {
        const timeText = recipe.totalTimeInMinutes === Infinity || recipe.totalTimeInMinutes == null
          ? 'Time N/A'
          : `${recipe.totalTimeInMinutes} min`;
        const imagePath = recipe.image
          ? (recipe.image.startsWith('http') ? recipe.image : `images/${recipe.image}`)
          : null;

        return `
          <article class="recipe-card" data-slug="${recipe.slug}">
            ${imagePath
              ? `<img src="${imagePath}" alt="${recipe.title}" class="recipe-card-image">`
              : '<div class="post-tile-placeholder">No Image Available</div>'
            }
            <div class="recipe-card-content">
              <h3 class="recipe-card-title">${recipe.title}</h3>
              <p class="card-description" style="font-size: 0.9em; color: var(--color-text-muted); margin: 8px 0;">
                ${recipe.description ? recipe.description.substring(0, 100) + '...' : 'A delicious recipe waiting to be made!'}
              </p>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px; font-size: 0.85em; color: var(--color-text-muted);">
                <span style="color: var(--color-accent); font-weight: 500;">${recipe.dishType || 'Recipe'}</span>
                <span>${timeText}</span>
              </div>
            </div>
          </article>
        `;
      }).join('');

      // Attach click listeners to recipe cards
      const cards = grid.querySelectorAll('.recipe-card');
      cards.forEach(card => {
        const slug = card.getAttribute('data-slug');
        if (slug) {
          card.addEventListener('click', () => {
            window.location.href = `recipe.html?slug=${encodeURIComponent(slug)}`;
          });
        }
      });

      if (loadMoreBtn) {
        loadMoreBtn.style.display = displayedRecipes < recipesToShow.length ? 'inline-block' : 'none';
      }

      window.currentFilteredRecipes = recipesToShow;
    }

    function applyFiltersAndDisplay() {
      const searchInput = document.getElementById('recipeSearch');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');

      let filtered = [...recipes];

      if (searchInput && searchInput.value.trim()) {
        const term = searchInput.value.trim().toLowerCase();
        filtered = filtered.filter(recipe =>
          (recipe.title || '').toLowerCase().includes(term) ||
          (recipe.description || '').toLowerCase().includes(term)
        );
      }

      if (categorySelect && categorySelect.value !== 'all') {
        filtered = filtered.filter(recipe =>
          (recipe.category || 'other').toLowerCase() === categorySelect.value.toLowerCase()
        );
      }

      if (dishTypeSelect && dishTypeSelect.value !== 'all') {
        filtered = filtered.filter(recipe =>
          (recipe.dishType || '').toLowerCase() === dishTypeSelect.value.toLowerCase()
        );
      }

      if (sortSelect && sortSelect.value === 'time') {
        filtered.sort((a, b) =>
          (a.totalTimeInMinutes || Infinity) - (b.totalTimeInMinutes || Infinity)
        );
      } else {
        filtered.sort((a, b) =>
          String(a.title || '').toLowerCase().localeCompare(String(b.title || '').toLowerCase())
        );
      }

      displayedRecipes = 0;
      updateRecipeCount(filtered.length, recipes.length);
      displayRecipes(filtered);
    }

    function loadMoreRecipes() {
      const recipesToShow = window.currentFilteredRecipes || recipes;
      displayedRecipes += RECIPES_PER_PAGE;
      displayRecipes(recipesToShow);
    }

    function clearFilters() {
      const searchInput = document.getElementById('recipeSearch');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');

      if (searchInput) searchInput.value = '';
      if (categorySelect) categorySelect.value = 'all';
      if (dishTypeSelect) dishTypeSelect.value = 'all';
      if (sortSelect) sortSelect.value = 'alphabetical';

      displayedRecipes = 0;
      updateRecipeCount(recipes.length, recipes.length);
      displayRecipes(recipes);
    }

    function setupRecipeListener() {
      const recipesRef = collection(db, "recipes");
      const q = query(recipesRef);

      onSnapshot(q, (snapshot) => {
        recipes = snapshot.docs.map(mapRecipe).filter(r => !r.isPlaceholder);

        recipes.sort((a, b) =>
          String(a.title || '').toLowerCase().localeCompare(String(b.title || '').toLowerCase())
        );

        displayedRecipes = 0;
        updateRecipeCount(recipes.length, recipes.length);
        displayRecipes(recipes);
      }, (error) => {
        console.error("Error fetching recipes:", error);
        const grid = document.getElementById('recipeGrid');
        const recipeCountEl = document.getElementById('recipeCount');
        if (grid) {
          grid.innerHTML = '<div class="no-results" style="grid-column: 1 / -1;">Unable to load recipes right now.</div>';
        }
        if (recipeCountEl) {
          recipeCountEl.textContent = '0 recipes (error loading)';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('recipeSearch');
      const searchBtn = document.getElementById('searchBtn');
      const clearBtn = document.getElementById('clearBtn');
      const categorySelect = document.getElementById('categoryFilter');
      const dishTypeSelect = document.getElementById('dishTypeFilter');
      const sortSelect = document.getElementById('sortBy');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      if (searchBtn) {
        searchBtn.addEventListener('click', applyFiltersAndDisplay);
      }

      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            applyFiltersAndDisplay();
          }
        });
      }

      if (categorySelect) {
        categorySelect.addEventListener('change', applyFiltersAndDisplay);
      }
      if (dishTypeSelect) {
        dishTypeSelect.addEventListener('change', applyFiltersAndDisplay);
      }
      if (sortSelect) {
        sortSelect.addEventListener('change', applyFiltersAndDisplay);
      }

      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', loadMoreRecipes);
      }

      if (clearBtn) {
        clearBtn.addEventListener('click', clearFilters);
      }
    });

    setupRecipeListener();
  </script>

  <!-- Navigation toggle via event listeners -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dropdown = document.getElementById('toolsDropdown');
      const toggleButtons = document.querySelectorAll('.menu-toggle, .tools-dropdown-btn');

      if (!dropdown || !toggleButtons.length) return;

      toggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          dropdown.classList.toggle('active');
        });
      });
    });
  </script>
</body>
</html>
