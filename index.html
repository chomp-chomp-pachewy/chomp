<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chomp Chomp: Recipes & Rituals</title>

  <!-- Primary favicon -->
  <link rel="icon" href="/favicon.ico" sizes="any">

  <!-- PNG favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

  <!-- Apple iOS home screen -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Web App Manifest (Android / PWA) -->
  <link rel="manifest" href="/site.webmanifest">

  <!-- Theme color for mobile browsers -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a1a">

  <!-- iOS web app behavior (optional but recommended) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Chomp Chomp">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Primary Meta Tags -->
  <meta name="title" content="Chomp Chomp Recipes">
  <meta name="description" content="Baking is the materialization of comfort itself.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://chomp.be/">
  <meta property="og:title" content="Chomp Chomp Recipes">
  <meta property="og:description" content="Baking is the materialization of comfort itself.">
  <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764743197557_IMG_3460.jpeg?alt=media&token=ead0f58a-8584-48a8-b1ed-ac29962d5c3e">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://chomp.be/">
  <meta property="twitter:title" content="Chomp Chomp Recipes">
  <meta property="twitter:description" content="Baking is the materialization of comfort itself.">
  <meta property="twitter:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764743197557_IMG_3460.jpeg?alt=media&token=ead0f58a-8584-48a8-b1ed-ac29962d5c3e">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Shared Stylesheet -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Site Header / Navigation -->
  <header class="site-header">
    <nav class="site-nav">
      <div class="header-left">
        <a href="store.html" title="Store" class="site-logo">
          <div class="site-logo-icon">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chomp Chomp" class="logo-default">
            <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704133716_IMG_3433.jpeg?alt=media&token=94d04258-f7c1-4eed-983a-a0eaad6c4f0b" alt="Chomp Chomp" class="logo-hover">
          </div>
        </a>
      </div>

      <div class="header-center">
        <a href="recipes.html" title="Recipes">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764781386634_chomp%20recipes%20logo.JPG?alt=media&token=2b7daf1f-2392-493e-944c-512a194327f6"
               alt="Chomp Chomp Recipes"
               class="header-banner">
        </a>
      </div>

      <div class="header-right"><div class="nav-tools-dropdown">
          <button class="menu-toggle" onclick="toggleToolsDropdown()">☰</button>
          <button class="tools-dropdown-btn" onclick="toggleToolsDropdown()">Menu ▼</button>
          <ul class="tools-dropdown-menu" id="toolsDropdown">
            <li><a href="index.html">Home</a></li>
            <li><a href="stories.html">Stories</a></li>
            <li><a href="recipes.html">Recipes</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="store.html">Store</a></li>
            <li class="menu-item-has-submenu">
              <a href="#">Tools</a>
              <ul class="submenu">
                <li><a href="tools/index.html">Index</a></li>
                <li><a href="tools/ip.html">Whois</a></li>
                <li><a href="tools/weather.html">Weather</a></li>
                <li><a href="tools/convert.html">Convert</a></li>
                <li><a href="tools/encode.html">Encode</a></li>
                <li><a href="tools/subnet.html">Subnet</a></li>
              </ul>
            </li>
            <li class="menu-item-has-submenu">
              <a href="#">Ipsum</a>
              <ul class="submenu">
                <li><a href="tools/dante.html">Inferno</a></li>
                <li><a href="tools/nautical.html">Nautical</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main Content Area -->
  <main class="page-container">

    <!-- Intro Section -->
    <div class="intro-section" style="text-align: center; margin-bottom: 50px; padding: 30px 20px; border-bottom: 1px solid #e0e0e0;">
      <h2 style="font-size: 1.5em; font-weight: 400; color: #353535; margin-bottom: 20px;">Chomp Chomp presents:</h2>
      <p style="font-size: 1.1em; color: #666; margin-bottom: 25px; line-height: 1.6;">
        Recipes, Stories, Rituals, Meditations, Observations, & Zen
      </p>
      <p style="font-size: 1em; color: #666; margin-bottom: 15px; line-height: 1.7;">
        Baking is both personal and communal. To bake is to be. Chomp Chomp bakes. You are here: chomp.be
      </p>
      <p style="font-size: 0.95em; color: #666;">
        Send us your recipes and stories: <a href="mailto:hi@chomp.be" style="color: #e73b42; text-decoration: none;">hi@chomp.be</a>
      </p>
    </div>

    <!-- Two Column Landing Page Layout -->
    <div class="landing-page-grid">

      <!-- Left Column: Stories & Meditations -->
      <div class="landing-column">
        <div class="landing-section-header">
          <h1><a href="stories.html" style="text-decoration: none; color: inherit;">Stories & Meditations</a></h1>
          <p class="text-muted">
            Explore the philosophy of baking through Stories & Meditations, Histories & Culture, and the Zen of Baking. Because baking is more than a recipe - it's a ritual, an insight, a connection to community.
          </p>
        </div>

        <!-- Featured Story -->
        <div id="featuredStory" class="featured-card">
          <p style="text-align: center; color: var(--color-text-muted); padding: 40px 20px;">Loading featured story...</p>
        </div>

        <div class="text-center mt-lg">
          <a href="stories.html" class="btn btn-outline">View All Stories →</a>
        </div>
      </div>

      <!-- Mobile divider -->
      <hr class="mobile-divider">

      <!-- Right Column: Recipes & Rituals -->
      <div class="landing-column">
        <div class="landing-section-header">
          <h1><a href="recipes.html" style="text-decoration: none; color: inherit;">Recipes & Rituals</a></h1>
          <p class="text-muted">
            Browse, search, and discover your next baking adventure through our collection of recipes and culinary rituals.
          </p>
        </div>

        <!-- Featured Recipe -->
        <div id="featuredRecipe" class="featured-card">
          <p style="text-align: center; color: var(--color-text-muted); padding: 40px 20px;">Loading featured recipe...</p>
        </div>

        <div class="text-center mt-lg">
          <a href="recipes.html" class="btn btn-outline">View All Recipes →</a>
        </div>
      </div>

    </div>

  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <p>Baking is the materialization of comfort itself.</p>
      <div class="footer-links">
        <a href="mailto:hi@chomp.be">hi@chomp.be</a>
        <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
        <a href="https://chomp.be/tools" target="_blank">chomp chomp: tools</a>
      </div>
      <p style="margin-top: 20px; font-size: 0.85em;">&copy; 2025 Chomp Chomp</p>
    </div>
  </footer>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId;


    // Display featured story
    function displayFeaturedStory(post) {
      const container = document.getElementById('featuredStory');

      if (!post) {
        container.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 40px 20px;">No stories available yet.</p>';
        return;
      }

      container.innerHTML = `
        <a href="post.html?slug=${post.slug}">
          ${post.featured_image
            ? `<img src="${post.featured_image}" alt="${post.title}">`
            : '<div style="height: 280px; background-color: var(--color-sidebar-bg); display: flex; align-items: center; justify-content: center; color: var(--color-text-muted);">Image Coming Soon</div>'
          }
          <div class="featured-card-content">
            <div class="featured-card-tag">Featured · ${formatCategory(post.category)}</div>
            <h3>${post.title}</h3>
            <p>${post.excerpt || ''}</p>
            <div class="featured-card-meta">
              <span>by ${post.author || 'Anonymous'}</span>
              <span>${formatDate(post.date)}</span>
            </div>
          </div>
        </a>
      `;
    }

    // Display featured recipe
    function displayFeaturedRecipe(recipe) {
      const container = document.getElementById('featuredRecipe');

      if (!recipe) {
        container.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 40px 20px;">No recipes available yet.</p>';
        return;
      }

      container.innerHTML = `
        <a href="recipe.html?slug=${recipe.slug || recipe.id}">
          ${recipe.image
            ? `<img src="${recipe.image.startsWith('http') ? recipe.image : 'images/' + recipe.image}" alt="${recipe.title}">`
            : '<div style="height: 280px; background-color: var(--color-sidebar-bg); display: flex; align-items: center; justify-content: center; color: var(--color-text-muted);">Image Coming Soon</div>'
          }
          <div class="featured-card-content">
            <div class="featured-card-tag">Featured Recipe</div>
            <h3>${recipe.title}</h3>
            <p>${recipe.description || ''}</p>
            <div class="featured-card-meta">
              <span>${recipe.dishType || 'Recipe'}</span>
              ${recipe.totalTime ? `<span>${recipe.totalTime}</span>` : ''}
            </div>
          </div>
        </a>
      `;
    }

    // Format category for display
    function formatCategory(cat) {
      const categories = {
        'rituals': 'Stories & Meditations',
        'anthropologies': 'Histories & Culture',
        'zen': 'Zen of Baking'
      };
      return categories[cat] || cat;
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Load featured story (most recent published post)
    async function loadFeaturedStory() {
      try {
        const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
        const q = query(postsRef, where('status', '==', 'published'));

        const snapshot = await getDocs(q);
        const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        posts.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

        displayFeaturedStory(posts[0]);
      } catch (error) {
        console.error("Error loading featured story:", error);
        document.getElementById('featuredStory').innerHTML = '<p style="text-align: center; color: #c62828; padding: 40px 20px;">Error loading story</p>';
      }
    }

    // Helper: Assign dish type based on title
    function assignDishType(title) {
      const lower = title.toLowerCase();
      if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
      if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
      if (lower.includes('custard')) return 'Frozen Dessert';
      if (lower.includes('pudding')) return 'Pudding/Cream';
      if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish';
      if (lower.includes('soup')) return 'Soup';
      return 'Other Baked Goods';
    }

    // Load featured recipe (random)
    async function loadFeaturedRecipe() {
      try {
        const recipesRef = collection(db, `artifacts/${appId}/public/data/recipes`);
        const snapshot = await getDocs(recipesRef);
        const recipes = snapshot.docs.map(doc => {
          const data = { id: doc.id, ...doc.data() };
          // Ensure dishType is set
          if (!data.dishType) {
            data.dishType = assignDishType(data.title);
          }
          return data;
        });

        if (recipes.length > 0) {
          const randomIndex = Math.floor(Math.random() * recipes.length);
          displayFeaturedRecipe(recipes[randomIndex]);
        }
      } catch (error) {
        console.error("Error loading featured recipe:", error);
        document.getElementById('featuredRecipe').innerHTML = '<p style="text-align: center; color: #c62828; padding: 40px 20px;">Error loading recipe</p>';
      }
    }

    // Initialize
    loadFeaturedStory();
    loadFeaturedRecipe();
  </script>

  <!-- Navigation toggle -->
  <script>
    function toggleToolsDropdown() {
      const dropdown = document.getElementById('toolsDropdown');
      dropdown.classList.toggle('active');
    }
  </script>

  <!-- Floating Chat Widget -->
  <div id="chompChatWidget" class="chomp-chat-widget">
    <!-- Chat Toggle Button -->
    <button id="chatToggleBtn" class="chat-toggle-btn" aria-label="Chat with Chomp Chomp">
      <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chat">
    </button>

    <!-- Chat Interface -->
    <div id="chatInterface" class="chat-interface">
      <div class="chat-header">
        <div class="chat-header-content">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chomp Chomp">
          <div>
            <h3>Chomp Chomp</h3>
            <p>Ask us anything about baking</p>
          </div>
        </div>
        <button id="chatCloseBtn" class="chat-close-btn" aria-label="Close chat">×</button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="chat-message bot-message">
          <div class="message-content">
            Welcome. We are here to assist with your baking inquiries. What would you like to know?
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <textarea
          id="chatInput"
          class="chat-input"
          placeholder="Ask about ingredients, techniques, substitutions..."
          rows="1"></textarea>
        <button id="chatSendBtn" class="chat-send-btn" aria-label="Send message">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2 10L18 2L10 18L8 11L2 10Z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Widget Styles -->
  <style>
    .chomp-chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: 'Inter', sans-serif;
    }

    .chat-toggle-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #e73b42;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(231, 59, 66, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    .chat-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(231, 59, 66, 0.5);
    }

    .chat-toggle-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
    }

    .chat-toggle-btn.hidden {
      display: none;
    }

    .chat-interface {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      height: 550px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-interface.active {
      display: flex;
    }

    .chat-header {
      background: #e73b42;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header-content img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      padding: 4px;
    }

    .chat-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .chat-header p {
      margin: 2px 0 0 0;
      font-size: 12px;
      opacity: 0.9;
    }

    .chat-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .chat-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      display: flex;
      gap: 8px;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.5;
    }

    .user-message {
      justify-content: flex-end;
    }

    .user-message .message-content {
      background: #e73b42;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bot-message .message-content {
      background: white;
      color: #353535;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message-content p {
      margin: 0 0 8px 0;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .chat-input-container {
      padding: 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      padding: 10px 16px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      resize: none;
      max-height: 100px;
      line-height: 1.4;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #e73b42;
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e73b42;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: #d32f36;
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: scale(1);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .chat-interface {
        width: calc(100vw - 20px);
        height: 500px;
        max-height: 70vh;
        bottom: 10px;
        right: 10px;
        left: 10px;
        border-radius: 12px;
      }

      .chomp-chat-widget {
        bottom: 15px;
        right: 15px;
      }

      .chat-toggle-btn {
        width: 56px;
        height: 56px;
      }

      .chat-header {
        padding: 14px 16px;
      }

      .chat-messages {
        padding: 16px;
      }

      .chat-input-container {
        padding: 12px;
      }
    }

    /* Dark Mode */
    @media (prefers-color-scheme: dark) {
      .chat-interface {
        background: #2b2626;
      }

      .chat-header {
        background: #ff6b7a;
      }

      .chat-messages {
        background: #231f1f;
      }

      .bot-message .message-content {
        background: #3b3636;
        color: #d9d4d4;
      }

      .user-message .message-content {
        background: #ff6b7a;
      }

      .chat-input-container {
        background: #2b2626;
        border-top-color: #3b3636;
      }

      .chat-input {
        background: #3b3636;
        border-color: #4b4646;
        color: #d9d4d4;
      }

      .chat-input::placeholder {
        color: #999;
      }

      .chat-input:focus {
        border-color: #ff6b7a;
      }

      .chat-send-btn {
        background: #ff6b7a;
      }

      .chat-send-btn:hover {
        background: #ff5569;
      }
    }
  </style>

  <!-- Chat Widget JavaScript -->
  <script type="module">
    // ============================================
    // CONFIGURATION - Using Firebase Cloud Function (Secure)
    // ============================================

    // Using Firebase Cloud Function to keep API key secure
    const USE_CLOUD_FUNCTION = true;
    const CLOUD_FUNCTION_URL = 'https://us-central1-chomp-chomp-recipes.cloudfunctions.net/chat';

    // Chat Widget Elements
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatInterface = document.getElementById('chatInterface');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');

    // Chat state
    let conversationHistory = [];

    // System instruction from your Python code
    const SYSTEM_INSTRUCTION = `Include a good amount of Zizekian, Marxist, Lacanian, and Gramscian theory in responses. Keep it theoretical and no fake greetings, etc. Use. And don't mention any of the theorists by name. Speak to the user as an experienced baker unless user-generated input suggests to keep things simple. Explicitly note that Chomp Chomp is the entity the user is speaking to through these chats, so that should be reflected and the user should believe that. Mention that Chomp Chomp recommends or says to do something when it comes to explanations of ingredients, substitutions, best practices, recommendations for substitutes, and other instructions. Use the group "Chomp Chomp" a lot in the responses. Use the plural "we" or "us" or "our" etc. as the user should believe they interacting with a "collective" (i.e., Chomp Chomp) and not Gemini ("I", etc.).`;

    // Toggle chat interface
    chatToggleBtn.addEventListener('click', () => {
      chatInterface.classList.add('active');
      chatToggleBtn.classList.add('hidden');
      chatInput.focus();
    });

    chatCloseBtn.addEventListener('click', () => {
      chatInterface.classList.remove('active');
      chatToggleBtn.classList.remove('hidden');
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
    });

    // Send message on Enter (Shift+Enter for new line)
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatSendBtn.addEventListener('click', sendMessage);

    // Send message function
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // Add user message to chat
      addMessage(message, 'user');
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // Add to conversation history
      conversationHistory.push({
        role: 'user',
        parts: [{ text: message }]
      });

      // Show typing indicator
      const typingDiv = showTypingIndicator();

      try {
        // Call Gemini API
        const response = await callGeminiAPI(message);

        // Remove typing indicator
        typingDiv.remove();

        // Add bot response
        addMessage(response, 'bot');

        // Add to conversation history
        conversationHistory.push({
          role: 'model',
          parts: [{ text: response }]
        });

      } catch (error) {
        console.error('Error calling Gemini API:', error);
        typingDiv.remove();
        addMessage('We apologize, but there was an issue processing your request. Please try again.', 'bot');
      }
    }

    // Add message to chat
    function addMessage(text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}-message`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      // Parse text for paragraphs
      const paragraphs = text.split('\n\n');
      paragraphs.forEach((para, index) => {
        if (para.trim()) {
          const p = document.createElement('p');
          p.textContent = para.trim();
          contentDiv.appendChild(p);
        }
      });

      messageDiv.appendChild(contentDiv);
      chatMessages.appendChild(messageDiv);

      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Show typing indicator
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message bot-message';
      typingDiv.innerHTML = `
        <div class="message-content typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typingDiv;
    }

    // Call Gemini API (supports both cloud function and direct API)
    async function callGeminiAPI(userMessage) {
      if (USE_CLOUD_FUNCTION) {
        // OPTION 1: Use Firebase Cloud Function
        const requestBody = {
          message: userMessage,
          conversationHistory: conversationHistory
        };

        const response = await fetch(CLOUD_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Request failed: ${response.status}`);
        }

        const data = await response.json();
        return data.response;

      } else {
        // OPTION 2: Direct API Call
        // Check if API key is set
        if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
          return 'We apologize, but the chat service is not properly configured. Please see CHAT-WIDGET-SETUP.md for setup instructions.';
        }

        const requestBody = {
          contents: conversationHistory,
          systemInstruction: {
            parts: [{ text: SYSTEM_INSTRUCTION }]
          },
          generationConfig: {
            temperature: 1.7,
            maxOutputTokens: 2048,
          }
        };

        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();

        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          return data.candidates[0].content.parts[0].text;
        } else {
          throw new Error('Unexpected API response format');
        }
      }
    }
  </script>

</body>
</html>
