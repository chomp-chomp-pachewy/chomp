<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather - Chomp Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tools-recipes-style.css">
</head>
<body>
    <header class="site-header">
        <nav class="site-nav">
            <a href="../index.html" class="site-logo">
                <div class="site-logo-icon">
                    <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704134358_IMG_3432.png?alt=media&token=24b33f57-609c-452c-b7cb-9e5cdf85859c" alt="Chomp Chomp" class="logo-default">
                    <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764704133716_IMG_3433.jpeg?alt=media&token=94d04258-f7c1-4eed-983a-a0eaad6c4f0b" alt="Chomp Chomp" class="logo-hover">
                </div>
            </a>
            <button class="menu-toggle" aria-label="Toggle menu">â˜°</button>
            <div class="nav-tools-dropdown">
                <button class="tools-dropdown-btn" onclick="toggleToolsDropdown()">Menu â–¼</button>
                <ul class="tools-dropdown-menu" id="toolsDropdown">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../stories.html">Stories</a></li>
                    <li><a href="../recipes.html">Recipes</a></li>
                    <li><a href="../about.html">About</a></li>
                    <li class="menu-item-has-submenu">
                        <a href="#">Tools</a>
                        <ul class="submenu">
                            <li><a href="index.html">Index</a></li>
                            <li><a href="ip.html">Whois</a></li>
                            <li><a href="weather.html">Weather</a></li>
                            <li><a href="convert.html">Convert</a></li>
                            <li><a href="encode.html">Encode</a></li>
                            <li><a href="subnet.html">Subnet</a></li>
                        </ul>
                    </li>
                    <li class="menu-item-has-submenu">
                        <a href="#">Ipsum</a>
                        <ul class="submenu">
                            <li><a href="dante.html">Inferno</a></li>
                            <li><a href="nautical.html">Nautical</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="page-container">
        <div class="tool-page">
            <div class="tool-header">
                <picture>
                    <source srcset="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2FWeather%20-%20dark.JPG?alt=media&token=2ee4f730-a289-4d56-8295-6721ffa1ead3" media="(prefers-color-scheme: dark)">
                    <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2FWeather%20-%20light.JPG?alt=media&token=ace15775-54bb-4566-9d7f-ba9effdbb871" alt="weather tools">
                </picture>
                <p class="tool-subtitle">Convert temperatures and calculate heat index, apparent temperature & comfort levels</p>
            </div>

            <!-- Current Weather -->
            <div class="tool-section">
                <h2 class="section-title">Current Weather</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Location</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="currentLat" class="form-input" placeholder="Latitude" step="0.0001" style="flex: 1;">
                            <input type="number" id="currentLon" class="form-input" placeholder="Longitude" step="0.0001" style="flex: 1;">
                        </div>
                    </div>

                    <div class="control-group" id="currentLocationDisplay" style="display: none;">
                        <label class="control-label">Location (from IP/GPS)</label>
                        <input type="text" id="currentLocationInfo" class="form-input" readonly placeholder="City, State, Country" style="background-color: var(--color-bg-secondary); cursor: not-allowed;">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="getCurrentWeather()">Get Current Weather</button>
                        <button class="tool-button tool-button-secondary" onclick="getLocationForCurrent()">Get My Location</button>
                        <button class="tool-button tool-button-secondary" onclick="resetCurrentWeather()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="currentWeatherResults" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Current Conditions</h3>

                    <div class="result-item">
                        <span class="result-label">Time:</span>
                        <span class="result-value" id="currentTime">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Temperature:</span>
                        <span class="result-value" id="currentTemp">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Today's High / Low:</span>
                        <span class="result-value" id="currentHighLow">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Feels Like:</span>
                        <span class="result-value" id="currentFeelsLike">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Humidity:</span>
                        <span class="result-value" id="currentHumidity">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Dew Point:</span>
                        <span class="result-value" id="currentDewPoint">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Wind:</span>
                        <span class="result-value" id="currentWind">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Pressure:</span>
                        <span class="result-value" id="currentPressure">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Precipitation (last hour):</span>
                        <span class="result-value" id="currentPrecip">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Cloud Cover:</span>
                        <span class="result-value" id="currentClouds">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Visibility:</span>
                        <span class="result-value" id="currentVisibility">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">UV Index:</span>
                        <span class="result-value" id="currentUV">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Weather:</span>
                        <span class="result-value" id="currentWeather">--</span>
                    </div>

                    <h3 style="margin: 20px 0 15px 0;">Today's Sun & Moon</h3>

                    <div class="result-item">
                        <span class="result-label">Sunrise:</span>
                        <span class="result-value" id="currentSunrise">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Sunset:</span>
                        <span class="result-value" id="currentSunset">--</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">Moon Phase:</span>
                        <span class="result-value" id="currentMoonPhase">--</span>
                    </div>
                </div>
            </div>

            <!-- Quick Temperature Converter -->
            <div class="tool-section">
                <h2 class="section-title">Quick Temperature Converter</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Fahrenheit</label>
                        <input type="number" id="fahrenheit" class="form-input" placeholder="Enter Â°F" oninput="convertFromF()">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Celsius</label>
                        <input type="number" id="celsius" class="form-input" placeholder="Enter Â°C" oninput="convertFromC()">
                    </div>
                </div>
            </div>

            <!-- Comprehensive Comfort Calculator -->
            <div class="tool-section">
                <h2 class="section-title">Heat Index Calculator</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Temperature</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="temp" class="form-input" placeholder="Enter temperature" style="flex: 2;">
                            <select id="unit" class="form-select" style="flex: 1;">
                                <option value="F">Â°F</option>
                                <option value="C">Â°C</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Relative Humidity (%)</label>
                        <input type="number" id="humidity" class="form-input" placeholder="Optional if dew point is given">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Dew Point (Â°F or Â°C to match temp)</label>
                        <input type="number" id="dewpoint" class="form-input" placeholder="Optional">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Wind Speed (m/s)</label>
                        <input type="number" id="wind" class="form-input" placeholder="Optional, default 0" value="0">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Sun Exposure (% full sun, 0â€“100)</label>
                        <input type="number" id="sun" class="form-input" placeholder="Optional, 0â€“100" value="0">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="calculateComfort()">Calculate Comfort</button>
                        <button class="tool-button tool-button-secondary" onclick="resetCalculator()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="results" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Results</h3>
                    <div class="result-item">
                        <span class="result-label">Estimated RH (if dew point used):</span>
                        <span class="result-value" id="calcRH">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Heat Index:</span>
                        <span class="result-value" id="fullHI">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Simplified Apparent Temperature:</span>
                        <span class="result-value" id="simpleHI">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Enhanced Apparent Temperature (w/ sun & wind):</span>
                        <span class="result-value" id="enhancedHI">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Dew Point Comfort Index:</span>
                        <span class="result-value" id="dewComfort">--</span>
                    </div>
                </div>
            </div>

            <!-- Wind Chill Calculator -->
            <div class="tool-section">
                <h2 class="section-title">Wind Chill Calculator</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Temperature</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="windChillTemp" class="form-input" placeholder="Enter temperature" style="flex: 2;">
                            <select id="windChillUnit" class="form-select" style="flex: 1;">
                                <option value="F">Â°F</option>
                                <option value="C">Â°C</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Wind Speed (mph)</label>
                        <input type="number" id="windSpeed" class="form-input" placeholder="Enter wind speed">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="calculateWindChill()">Calculate</button>
                        <button class="tool-button tool-button-secondary" onclick="resetWindChill()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="windChillResults" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Results</h3>
                    <div class="result-item">
                        <span class="result-label">Wind Chill Temperature:</span>
                        <span class="result-value" id="windChillValue">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Comfort Level:</span>
                        <span class="result-value" id="windChillComfort">--</span>
                    </div>
                </div>
            </div>

            <!-- UV Index Calculator -->
            <div class="tool-section">
                <h2 class="section-title">UV Index Calculator</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Latitude</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="uvLat" class="form-input" placeholder="e.g., 40.7128" step="0.0001" style="flex: 1;">
                            <button class="tool-button tool-button-secondary" onclick="getLocationForUV()" style="flex: 0 0 auto; white-space: nowrap;">Get My Location</button>
                        </div>
                    </div>

                    <div class="control-group" id="uvLocationDisplay" style="display: none;">
                        <label class="control-label">Location (from IP/GPS)</label>
                        <input type="text" id="uvLocationInfo" class="form-input" readonly placeholder="City, State, Country" style="background-color: var(--color-bg-secondary); cursor: not-allowed;">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Date</label>
                        <input type="date" id="uvDate" class="form-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Time of Day</label>
                        <input type="time" id="uvTime" class="form-input">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Cloud Cover (%)</label>
                        <input type="number" id="uvCloud" class="form-input" placeholder="0-100" value="0" min="0" max="100">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="calculateUV()">Calculate UV Index</button>
                        <button class="tool-button tool-button-secondary" onclick="resetUV()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="uvResults" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Results</h3>
                    <div class="result-item">
                        <span class="result-label">Estimated UV Index:</span>
                        <span class="result-value" id="uvIndex">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Risk Level:</span>
                        <span class="result-value" id="uvRisk">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Protection Recommended:</span>
                        <span class="result-value" id="uvProtection">--</span>
                    </div>
                </div>
            </div>

            <!-- Sun & Moon Rise/Set Calculator -->
            <div class="tool-section">
                <h2 class="section-title">Sun & Moon Rise/Set Calculator</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Location</label>
                        <button class="tool-button tool-button-secondary" onclick="getLocationForSun()" style="width: 100%;">Get My Location</button>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Latitude</label>
                        <input type="number" id="sunLat" class="form-input" placeholder="e.g., 40.7128" step="0.0001">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Longitude</label>
                        <input type="number" id="sunLon" class="form-input" placeholder="e.g., -74.0060" step="0.0001">
                    </div>

                    <div class="control-group" id="sunLocationDisplay" style="display: none;">
                        <label class="control-label">Location (from IP/GPS)</label>
                        <input type="text" id="sunLocationInfo" class="form-input" readonly placeholder="City, State, Country" style="background-color: var(--color-bg-secondary); cursor: not-allowed;">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Date</label>
                        <input type="date" id="sunDate" class="form-input">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="calculateSunTimes()">Calculate</button>
                        <button class="tool-button tool-button-secondary" onclick="resetSunTimes()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="sunResults" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Sun</h3>
                    <div class="result-item">
                        <span class="result-label">Sunrise:</span>
                        <span class="result-value" id="sunrise">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Sunset:</span>
                        <span class="result-value" id="sunset">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Daylight Hours:</span>
                        <span class="result-value" id="daylight">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Solar Noon:</span>
                        <span class="result-value" id="solarNoon">--</span>
                    </div>
                    <h3 style="margin: 20px 0 15px 0;">Moon</h3>
                    <div class="result-item">
                        <span class="result-label">Moonrise:</span>
                        <span class="result-value" id="moonrise">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Moonset:</span>
                        <span class="result-value" id="moonset">--</span>
                    </div>
                </div>
            </div>

            <!-- Moon Phase Calculator -->
            <div class="tool-section">
                <h2 class="section-title">Moon Phase Calculator</h2>
                <div class="tool-controls">
                    <div class="control-group">
                        <label class="control-label">Date</label>
                        <input type="date" id="moonDate" class="form-input">
                    </div>

                    <div class="tool-actions">
                        <button class="tool-button" onclick="calculateMoonPhase()">Calculate</button>
                        <button class="tool-button tool-button-secondary" onclick="resetMoonPhase()">Reset</button>
                    </div>
                </div>

                <div class="tool-result" id="moonResults" style="display: none;">
                    <h3 style="margin-bottom: 15px;">Results</h3>
                    <div class="result-item">
                        <span class="result-label">Moon Phase:</span>
                        <span class="result-value" id="moonPhase">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Illumination:</span>
                        <span class="result-value" id="moonIllumination">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Age (days):</span>
                        <span class="result-value" id="moonAge">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Phase Emoji:</span>
                        <span class="result-value" id="moonEmoji" style="font-size: 2em;">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <p>Baking is the materialization of comfort itself.</p>
            <div class="footer-links">
                <a href="mailto:hi@chomp.be">hi@chomp.be</a>
                <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
                <a href="https://chomp.be/tools" target="_blank">chomp chomp: tools</a>
            </div>
            <p style="margin-top: 20px; font-size: 0.85em;">&copy; 2025 Chomp Chomp</p>
        </div>
    </footer>

    <script>
        // Quick Temperature Converter
        function convertFromF() {
            const f = parseFloat(document.getElementById('fahrenheit').value);
            if (!isNaN(f)) {
                const c = (f - 32) * 5 / 9;
                document.getElementById('celsius').value = c.toFixed(2);
            } else {
                document.getElementById('celsius').value = '';
            }
        }

        function convertFromC() {
            const c = parseFloat(document.getElementById('celsius').value);
            if (!isNaN(c)) {
                const f = c * 9 / 5 + 32;
                document.getElementById('fahrenheit').value = f.toFixed(2);
            } else {
                document.getElementById('fahrenheit').value = '';
            }
        }

        // Helper functions
        function toFahrenheit(temp, unit) {
            return unit === 'C' ? (temp * 9 / 5 + 32) : temp;
        }

        function toCelsius(temp, unit) {
            return unit === 'F' ? (temp - 32) * 5 / 9 : temp;
        }

        function dewComfort(dewF) {
            if (dewF < 50) return "Dry and comfortable";
            if (dewF < 60) return "Pleasant";
            if (dewF < 65) return "A bit humid";
            if (dewF < 70) return "Humid and muggy";
            if (dewF < 75) return "Sticky and oppressive";
            return "Extremely humid and uncomfortable";
        }

        function fullHeatIndex(T, R) {
            if (T < 80 || R < 40) return T.toFixed(2);
            let HI = -42.379 + 2.04901523 * T + 10.14333127 * R
                     - 0.22475541 * T * R - 6.83783e-3 * T * T
                     - 5.481717e-2 * R * R + 1.22874e-3 * T * T * R
                     + 8.5282e-4 * T * R * R - 1.99e-6 * T * T * R * R;
            return HI.toFixed(2);
        }

        function simplifiedApparentTemp(T, R, wind) {
            let HI = T + 0.33 * R - 0.70 * wind - 4.00;
            return HI.toFixed(2);
        }

        function enhancedApparentTemp(T, R, wind, sun) {
            let sunEffect = T * (sun / 100) * 0.07;
            let adjustedT = T + sunEffect;
            return simplifiedApparentTemp(adjustedT, R, wind);
        }

        function estimateRH(tempC, dewC) {
            let e_t = 6.112 * Math.exp((17.67 * tempC) / (tempC + 243.5));
            let e_td = 6.112 * Math.exp((17.67 * dewC) / (dewC + 243.5));
            let rh = 100 * (e_td / e_t);
            return Math.round(rh * 100) / 100;
        }

        function calculateComfort() {
            let T = parseFloat(document.getElementById("temp").value);
            let unit = document.getElementById("unit").value;
            let R = parseFloat(document.getElementById("humidity").value);
            let dew = document.getElementById("dewpoint").value;
            let wind = parseFloat(document.getElementById("wind").value || "0");
            let sun = parseFloat(document.getElementById("sun").value || "0");

            if (isNaN(T)) {
                alert("Please enter a valid temperature.");
                return;
            }

            let Tf = toFahrenheit(T, unit);
            let dewF = dew ? toFahrenheit(parseFloat(dew), unit) : null;
            let tempC = toCelsius(T, unit);
            let dewC = dew ? toCelsius(parseFloat(dew), unit) : null;

            let computedRH = (!isNaN(R)) ? R : (dew ? estimateRH(tempC, dewC) : null);
            let RHdisplay = computedRH ? computedRH.toFixed(2) + "%" : "(RH not available)";
            document.getElementById("calcRH").innerText = RHdisplay;

            let displayRH = computedRH || 0;

            document.getElementById("fullHI").innerText = fullHeatIndex(Tf, displayRH) + " Â°F";
            document.getElementById("simpleHI").innerText = simplifiedApparentTemp(Tf, displayRH, wind) + " Â°F";
            document.getElementById("enhancedHI").innerText = enhancedApparentTemp(Tf, displayRH, wind, sun) + " Â°F";
            document.getElementById("dewComfort").innerText = dewF ? dewComfort(dewF) : "(No dew point given)";

            document.getElementById("results").style.display = "block";
        }

        function resetCalculator() {
            document.getElementById("temp").value = "";
            document.getElementById("humidity").value = "";
            document.getElementById("dewpoint").value = "";
            document.getElementById("wind").value = "0";
            document.getElementById("sun").value = "0";
            document.getElementById("results").style.display = "none";
        }

        function toggleToolsDropdown() {
            const dropdown = document.getElementById('toolsDropdown');
            dropdown.classList.toggle('active');
        }

        // Wind Chill Calculator
        function calculateWindChill() {
            const temp = parseFloat(document.getElementById('windChillTemp').value);
            const unit = document.getElementById('windChillUnit').value;
            const windSpeed = parseFloat(document.getElementById('windSpeed').value);

            if (isNaN(temp) || isNaN(windSpeed)) {
                alert('Please enter valid temperature and wind speed values.');
                return;
            }

            // Convert to Fahrenheit for calculation
            const tempF = unit === 'C' ? (temp * 9/5 + 32) : temp;

            // Wind chill formula (valid for temps â‰¤ 50Â°F and wind speed â‰¥ 3 mph)
            let windChill;
            if (tempF > 50 || windSpeed < 3) {
                windChill = tempF;
            } else {
                windChill = 35.74 + (0.6215 * tempF) - (35.75 * Math.pow(windSpeed, 0.16)) + (0.4275 * tempF * Math.pow(windSpeed, 0.16));
            }

            // Convert back to selected unit
            const windChillDisplay = unit === 'C' ? (windChill - 32) * 5/9 : windChill;

            document.getElementById('windChillValue').textContent = `${windChillDisplay.toFixed(2)} Â°${unit}`;

            // Comfort assessment
            let comfort;
            if (windChillDisplay < -18) comfort = "Extreme danger: Frostbite in minutes";
            else if (windChillDisplay < -9) comfort = "Danger: Frostbite possible";
            else if (windChillDisplay < 0) comfort = "Very cold: Exposed skin uncomfortable";
            else if (windChillDisplay < 10) comfort = "Cold: Dress warmly";
            else comfort = "Chilly: Light jacket recommended";

            document.getElementById('windChillComfort').textContent = comfort;
            document.getElementById('windChillResults').style.display = 'block';
        }

        function resetWindChill() {
            document.getElementById('windChillTemp').value = '';
            document.getElementById('windSpeed').value = '';
            document.getElementById('windChillResults').style.display = 'none';
        }

        // UV Index Calculator
        function calculateUV() {
            const lat = parseFloat(document.getElementById('uvLat').value);
            const dateStr = document.getElementById('uvDate').value;
            const timeStr = document.getElementById('uvTime').value;
            const cloudCover = parseFloat(document.getElementById('uvCloud').value) || 0;

            if (isNaN(lat) || !dateStr || !timeStr) {
                alert('Please enter latitude, date, and time.');
                return;
            }

            const date = new Date(dateStr + 'T' + timeStr);
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const hour = date.getHours() + date.getMinutes() / 60;

            // Solar declination angle (approximation)
            const declination = 23.45 * Math.sin((360/365) * (dayOfYear - 81) * Math.PI / 180);

            // Hour angle
            const hourAngle = 15 * (hour - 12);

            // Solar elevation angle
            const latRad = lat * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            const hourRad = hourAngle * Math.PI / 180;

            const sinElevation = Math.sin(latRad) * Math.sin(decRad) +
                                 Math.cos(latRad) * Math.cos(decRad) * Math.cos(hourRad);
            const elevation = Math.asin(sinElevation) * 180 / Math.PI;

            // Base UV index calculation (simplified)
            let uvIndex = 0;
            if (elevation > 0) {
                uvIndex = 12 * Math.sin(elevation * Math.PI / 180);

                // Adjust for cloud cover
                uvIndex *= (1 - cloudCover / 200);

                // Seasonal adjustment
                const seasonFactor = 0.8 + 0.4 * Math.sin((dayOfYear - 172) * Math.PI / 182.5);
                uvIndex *= seasonFactor;
            }

            uvIndex = Math.max(0, Math.round(uvIndex * 10) / 10);

            document.getElementById('uvIndex').textContent = uvIndex.toFixed(1);

            // Risk assessment
            let risk, protection;
            if (uvIndex < 3) {
                risk = "Low";
                protection = "Minimal protection needed";
            } else if (uvIndex < 6) {
                risk = "Moderate";
                protection = "Wear sunscreen, seek shade during midday";
            } else if (uvIndex < 8) {
                risk = "High";
                protection = "Sunscreen, hat, and shade essential";
            } else if (uvIndex < 11) {
                risk = "Very High";
                protection = "Extra protection required, avoid sun 10am-4pm";
            } else {
                risk = "Extreme";
                protection = "Minimize sun exposure, full protection necessary";
            }

            document.getElementById('uvRisk').textContent = risk;
            document.getElementById('uvProtection').textContent = protection;
            document.getElementById('uvResults').style.display = 'block';
        }

        function resetUV() {
            document.getElementById('uvLat').value = '';
            document.getElementById('uvDate').value = '';
            document.getElementById('uvTime').value = '';
            document.getElementById('uvCloud').value = '0';
            document.getElementById('uvLocationDisplay').style.display = 'none';
            document.getElementById('uvLocationInfo').value = '';
            document.getElementById('uvResults').style.display = 'none';
        }

        // Sunrise/Sunset Calculator
        function calculateSunTimes() {
            const lat = parseFloat(document.getElementById('sunLat').value);
            const lon = parseFloat(document.getElementById('sunLon').value);
            const dateStr = document.getElementById('sunDate').value;

            if (isNaN(lat) || isNaN(lon) || !dateStr) {
                alert('Please enter latitude, longitude, and date.');
                return;
            }

            const date = new Date(dateStr);
            const julianDay = Math.floor((date / 86400000) + 2440587.5);
            const n = julianDay - 2451545.0 + 0.0008;

            // Mean solar time
            const J = n - lon / 360;

            // Solar mean anomaly
            const M = (357.5291 + 0.98560028 * J) % 360;
            const Mrad = M * Math.PI / 180;

            // Equation of center
            const C = 1.9148 * Math.sin(Mrad) + 0.0200 * Math.sin(2 * Mrad) + 0.0003 * Math.sin(3 * Mrad);

            // Ecliptic longitude
            const lambda = (M + C + 180 + 102.9372) % 360;
            const lambdaRad = lambda * Math.PI / 180;

            // Solar transit
            const Jtransit = 2451545.0 + J + 0.0053 * Math.sin(Mrad) - 0.0069 * Math.sin(2 * lambdaRad);

            // Declination of the sun
            const delta = Math.asin(Math.sin(lambdaRad) * Math.sin(23.44 * Math.PI / 180));

            // Hour angle
            const latRad = lat * Math.PI / 180;
            const cosOmega = (Math.sin(-0.833 * Math.PI / 180) - Math.sin(latRad) * Math.sin(delta)) /
                             (Math.cos(latRad) * Math.cos(delta));

            if (cosOmega > 1 || cosOmega < -1) {
                alert('No sunrise/sunset at this location on this date (polar day/night).');
                return;
            }

            const omega = Math.acos(cosOmega) * 180 / Math.PI;

            // Sunrise and sunset
            const Jrise = Jtransit - omega / 360;
            const Jset = Jtransit + omega / 360;

            // Convert to local time
            const msInDay = 86400000;
            const sunriseDate = new Date((Jrise - 2440587.5) * msInDay);
            const sunsetDate = new Date((Jset - 2440587.5) * msInDay);
            const solarNoonDate = new Date((Jtransit - 2440587.5) * msInDay);

            const daylightMs = sunsetDate - sunriseDate;
            const daylightHours = Math.floor(daylightMs / 3600000);
            const daylightMinutes = Math.floor((daylightMs % 3600000) / 60000);

            document.getElementById('sunrise').textContent = sunriseDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('sunset').textContent = sunsetDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('daylight').textContent = `${daylightHours}h ${daylightMinutes}m`;
            document.getElementById('solarNoon').textContent = solarNoonDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

            // Calculate moon rise and set
            calculateMoonRiseSet(lat, lon, date);

            document.getElementById('sunResults').style.display = 'block';
        }

        function calculateMoonRiseSet(lat, lon, date) {
            // Moon calculations are more complex than sun calculations
            // This is a simplified algorithm

            // Calculate moon's position
            const julianDay = Math.floor((date / 86400000) + 2440587.5);
            const T = (julianDay - 2451545.0) / 36525;

            // Moon's mean longitude
            const L0 = (218.316 + 13.176396 * (julianDay - 2451545)) % 360;

            // Mean anomaly
            const M = (134.963 + 13.064993 * (julianDay - 2451545)) % 360;
            const Mrad = M * Math.PI / 180;

            // Mean distance
            const F = (93.272 + 13.229350 * (julianDay - 2451545)) % 360;

            // Longitude
            const moonLon = (L0 + 6.289 * Math.sin(Mrad)) % 360;
            const moonLonRad = moonLon * Math.PI / 180;

            // Latitude
            const moonLat = 5.128 * Math.sin((F * Math.PI / 180));
            const moonLatRad = moonLat * Math.PI / 180;

            // Declination
            const epsilon = 23.439 - 0.0000004 * (julianDay - 2451545);
            const epsilonRad = epsilon * Math.PI / 180;
            const declination = Math.asin(Math.sin(moonLatRad) * Math.cos(epsilonRad) +
                                         Math.cos(moonLatRad) * Math.sin(epsilonRad) * Math.sin(moonLonRad));

            // Hour angle for rise/set (using -0.833 degrees for standard horizon)
            const latRad = lat * Math.PI / 180;
            const cosH = (Math.sin(-0.833 * Math.PI / 180) - Math.sin(latRad) * Math.sin(declination)) /
                        (Math.cos(latRad) * Math.cos(declination));

            if (cosH > 1) {
                document.getElementById('moonrise').textContent = 'Moon does not rise';
                document.getElementById('moonset').textContent = 'Moon does not set';
                return;
            }

            if (cosH < -1) {
                document.getElementById('moonrise').textContent = 'Moon always above horizon';
                document.getElementById('moonset').textContent = 'Moon always above horizon';
                return;
            }

            const H = Math.acos(cosH);
            const Hdeg = H * 180 / Math.PI;

            // Calculate transit time
            const RA = Math.atan2(Math.sin(moonLonRad) * Math.cos(epsilonRad) -
                                 Math.tan(moonLatRad) * Math.sin(epsilonRad),
                                 Math.cos(moonLonRad));
            const RAdeg = (RA * 180 / Math.PI + 360) % 360;

            const LST_transit = RAdeg / 15; // Convert to hours
            const moonTransit = LST_transit - lon / 15; // Adjust for longitude

            const moonriseHour = ((moonTransit - Hdeg / 15 + 24) % 24);
            const moonsetHour = ((moonTransit + Hdeg / 15 + 24) % 24);

            // Create dates for moonrise and moonset
            const moonriseDate = new Date(date);
            moonriseDate.setHours(Math.floor(moonriseHour), Math.floor((moonriseHour % 1) * 60), 0, 0);

            const moonsetDate = new Date(date);
            moonsetDate.setHours(Math.floor(moonsetHour), Math.floor((moonsetHour % 1) * 60), 0, 0);

            document.getElementById('moonrise').textContent = moonriseDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('moonset').textContent = moonsetDate.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        }

        function resetSunTimes() {
            document.getElementById('sunLat').value = '';
            document.getElementById('sunLon').value = '';
            document.getElementById('sunDate').value = '';
            document.getElementById('sunLocationDisplay').style.display = 'none';
            document.getElementById('sunLocationInfo').value = '';
            document.getElementById('sunResults').style.display = 'none';
        }

        // Moon Phase Calculator
        function calculateMoonPhase() {
            const dateStr = document.getElementById('moonDate').value;

            if (!dateStr) {
                alert('Please enter a date.');
                return;
            }

            const date = new Date(dateStr);

            // Known new moon: January 6, 2000, 18:14 UTC
            const knownNewMoon = new Date('2000-01-06T18:14:00Z');
            const synodicMonth = 29.53058867; // days

            // Calculate days since known new moon
            const daysSince = (date - knownNewMoon) / (1000 * 60 * 60 * 24);

            // Calculate current position in lunar cycle
            const cyclePosition = daysSince % synodicMonth;
            const age = cyclePosition < 0 ? cyclePosition + synodicMonth : cyclePosition;

            // Calculate illumination
            const illumination = (1 - Math.cos(age / synodicMonth * 2 * Math.PI)) / 2;

            // Determine phase name
            let phaseName, emoji;
            if (age < 1.84566) {
                phaseName = "New Moon";
                emoji = "ðŸŒ‘";
            } else if (age < 5.53699) {
                phaseName = "Waxing Crescent";
                emoji = "ðŸŒ’";
            } else if (age < 9.22831) {
                phaseName = "First Quarter";
                emoji = "ðŸŒ“";
            } else if (age < 12.91963) {
                phaseName = "Waxing Gibbous";
                emoji = "ðŸŒ”";
            } else if (age < 16.61096) {
                phaseName = "Full Moon";
                emoji = "ðŸŒ•";
            } else if (age < 20.30228) {
                phaseName = "Waning Gibbous";
                emoji = "ðŸŒ–";
            } else if (age < 23.99361) {
                phaseName = "Last Quarter";
                emoji = "ðŸŒ—";
            } else if (age < 27.68493) {
                phaseName = "Waning Crescent";
                emoji = "ðŸŒ˜";
            } else {
                phaseName = "New Moon";
                emoji = "ðŸŒ‘";
            }

            document.getElementById('moonPhase').textContent = phaseName;
            document.getElementById('moonIllumination').textContent = `${(illumination * 100).toFixed(1)}%`;
            document.getElementById('moonAge').textContent = age.toFixed(2);
            document.getElementById('moonEmoji').textContent = emoji;
            document.getElementById('moonResults').style.display = 'block';
        }

        function resetMoonPhase() {
            document.getElementById('moonDate').value = '';
            document.getElementById('moonResults').style.display = 'none';
        }

        // Current Weather functions
        async function getCurrentWeather() {
            const lat = parseFloat(document.getElementById('currentLat').value);
            const lon = parseFloat(document.getElementById('currentLon').value);

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude, or use "Get My Location".');
                return;
            }

            try {
                // Build API URL with all available current parameters
                const params = [
                    'temperature_2m',
                    'relative_humidity_2m',
                    'apparent_temperature',
                    'is_day',
                    'precipitation',
                    'rain',
                    'showers',
                    'snowfall',
                    'weather_code',
                    'cloud_cover',
                    'pressure_msl',
                    'surface_pressure',
                    'wind_speed_10m',
                    'wind_direction_10m',
                    'wind_gusts_10m',
                    'dew_point_2m',
                    'visibility'
                ];

                const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=${params.join(',')}&daily=sunrise,sunset,uv_index_max,precipitation_sum,temperature_2m_max,temperature_2m_min&timezone=auto&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.current) {
                    const current = data.current;
                    const daily = data.daily;

                    // Time
                    const time = new Date(current.time);
                    document.getElementById('currentTime').textContent = time.toLocaleString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Temperature
                    document.getElementById('currentTemp').textContent = `${current.temperature_2m.toFixed(1)}Â°F`;

                    // Today's High / Low
                    if (daily && daily.temperature_2m_max && daily.temperature_2m_min) {
                        const high = daily.temperature_2m_max[0].toFixed(1);
                        const low = daily.temperature_2m_min[0].toFixed(1);
                        document.getElementById('currentHighLow').textContent = `${high}Â°F / ${low}Â°F`;
                    } else {
                        document.getElementById('currentHighLow').textContent = 'N/A';
                    }

                    // Feels Like (Apparent Temperature)
                    document.getElementById('currentFeelsLike').textContent = `${current.apparent_temperature.toFixed(1)}Â°F`;

                    // Humidity
                    document.getElementById('currentHumidity').textContent = `${current.relative_humidity_2m}%`;

                    // Dew Point
                    document.getElementById('currentDewPoint').textContent = `${current.dew_point_2m.toFixed(1)}Â°F`;

                    // Wind
                    const windDir = getWindDirection(current.wind_direction_10m);
                    document.getElementById('currentWind').textContent =
                        `${current.wind_speed_10m.toFixed(1)} mph ${windDir} (gusts ${current.wind_gusts_10m.toFixed(1)} mph)`;

                    // Pressure
                    const pressureInHg = (current.pressure_msl * 0.02953).toFixed(2);
                    document.getElementById('currentPressure').textContent = `${current.pressure_msl.toFixed(1)} hPa (${pressureInHg} inHg)`;

                    // Precipitation (total of rain + showers + snow)
                    const totalPrecip = (current.rain || 0) + (current.showers || 0) + (current.snowfall || 0);
                    document.getElementById('currentPrecip').textContent = totalPrecip > 0
                        ? `${totalPrecip.toFixed(2)} in (rain: ${(current.rain || 0).toFixed(2)}, showers: ${(current.showers || 0).toFixed(2)}, snow: ${(current.snowfall || 0).toFixed(2)})`
                        : 'None';

                    // Cloud Cover
                    document.getElementById('currentClouds').textContent = `${current.cloud_cover}%`;

                    // Visibility
                    const visibilityMiles = (current.visibility / 1609.34).toFixed(2);
                    document.getElementById('currentVisibility').textContent = `${visibilityMiles} mi (${(current.visibility / 1000).toFixed(1)} km)`;

                    // UV Index (from daily max)
                    if (daily && daily.uv_index_max && daily.uv_index_max[0] !== undefined) {
                        document.getElementById('currentUV').textContent = daily.uv_index_max[0].toFixed(1);
                    } else {
                        document.getElementById('currentUV').textContent = 'N/A';
                    }

                    // Weather Description
                    document.getElementById('currentWeather').textContent = getWeatherDescription(current.weather_code, current.is_day);

                    // Sunrise/Sunset
                    if (daily && daily.sunrise && daily.sunset) {
                        const sunrise = new Date(daily.sunrise[0]);
                        const sunset = new Date(daily.sunset[0]);
                        document.getElementById('currentSunrise').textContent = sunrise.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                        document.getElementById('currentSunset').textContent = sunset.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                    }

                    // Moon Phase (calculate from today's date)
                    const today = new Date();
                    const knownNewMoon = new Date('2000-01-06T18:14:00Z');
                    const synodicMonth = 29.53058867;
                    const daysSince = (today - knownNewMoon) / (1000 * 60 * 60 * 24);
                    const age = (daysSince % synodicMonth + synodicMonth) % synodicMonth;

                    let phaseName;
                    if (age < 1.84566) phaseName = "ðŸŒ‘ New Moon";
                    else if (age < 5.53699) phaseName = "ðŸŒ’ Waxing Crescent";
                    else if (age < 9.22831) phaseName = "ðŸŒ“ First Quarter";
                    else if (age < 12.91963) phaseName = "ðŸŒ” Waxing Gibbous";
                    else if (age < 16.61096) phaseName = "ðŸŒ• Full Moon";
                    else if (age < 20.30228) phaseName = "ðŸŒ– Waning Gibbous";
                    else if (age < 23.99361) phaseName = "ðŸŒ— Last Quarter";
                    else if (age < 27.68493) phaseName = "ðŸŒ˜ Waning Crescent";
                    else phaseName = "ðŸŒ‘ New Moon";

                    document.getElementById('currentMoonPhase').textContent = phaseName;

                    document.getElementById('currentWeatherResults').style.display = 'block';
                } else {
                    alert('Unable to fetch weather data. Please try again.');
                }
            } catch (error) {
                console.error('Weather API error:', error);
                alert('Error fetching weather data: ' + error.message);
            }
        }

        // Helper function to convert wind direction degrees to compass direction
        function getWindDirection(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Helper function to convert WMO weather codes to descriptions
        function getWeatherDescription(code, isDay) {
            const weatherCodes = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                56: 'Light freezing drizzle',
                57: 'Dense freezing drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                66: 'Light freezing rain',
                67: 'Heavy freezing rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail',
                99: 'Thunderstorm with heavy hail'
            };

            return weatherCodes[code] || 'Unknown';
        }

        async function getLocationForCurrent() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Getting location...';
            button.disabled = true;

            // Try GPS first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);

                        document.getElementById('currentLat').value = lat;
                        document.getElementById('currentLon').value = lon;

                        // Fetch location name using reverse geocoding
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                            const data = await response.json();

                            if (data.address) {
                                const city = data.address.city || data.address.town || data.address.village || '';
                                const state = data.address.state || '';
                                const country = data.address.country || '';

                                let locationStr = [city, state, country].filter(x => x).join(', ');
                                document.getElementById('currentLocationInfo').value = locationStr + ' (GPS)';
                                document.getElementById('currentLocationDisplay').style.display = 'block';
                            }
                        } catch (err) {
                            console.error('Reverse geocoding error:', err);
                        }

                        button.textContent = 'Location Found!';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 2000);
                    },
                    async (error) => {
                        // GPS failed, try IP-based location
                        console.log('GPS failed, trying IP geolocation...');
                        await fallbackToIPLocation('current', button, originalText);
                    }
                );
            } else {
                // No geolocation support, use IP fallback
                await fallbackToIPLocation('current', button, originalText);
            }
        }

        function resetCurrentWeather() {
            document.getElementById('currentLat').value = '';
            document.getElementById('currentLon').value = '';
            document.getElementById('currentLocationDisplay').style.display = 'none';
            document.getElementById('currentLocationInfo').value = '';
            document.getElementById('currentWeatherResults').style.display = 'none';
        }

        // Geolocation functions
        async function getLocationForUV() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Getting location...';
            button.disabled = true;

            // Try GPS first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);

                        document.getElementById('uvLat').value = lat;

                        // Fetch location name using reverse geocoding
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                            const data = await response.json();

                            if (data.address) {
                                const city = data.address.city || data.address.town || data.address.village || '';
                                const state = data.address.state || '';
                                const country = data.address.country || '';

                                let locationStr = [city, state, country].filter(x => x).join(', ');
                                document.getElementById('uvLocationInfo').value = locationStr + ' (GPS)';
                                document.getElementById('uvLocationDisplay').style.display = 'block';
                            }
                        } catch (err) {
                            console.error('Reverse geocoding error:', err);
                        }

                        button.textContent = 'Location Found!';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 2000);
                    },
                    async (error) => {
                        // GPS failed, try IP-based location
                        console.log('GPS failed, trying IP geolocation...');
                        await fallbackToIPLocation('uv', button, originalText);
                    }
                );
            } else {
                // No geolocation support, use IP fallback
                await fallbackToIPLocation('uv', button, originalText);
            }
        }

        async function getLocationForSun() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Getting location...';
            button.disabled = true;

            // Try GPS first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);

                        document.getElementById('sunLat').value = lat;
                        document.getElementById('sunLon').value = lon;

                        // Fetch location name using reverse geocoding
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                            const data = await response.json();

                            if (data.address) {
                                const city = data.address.city || data.address.town || data.address.village || '';
                                const state = data.address.state || '';
                                const country = data.address.country || '';

                                let locationStr = [city, state, country].filter(x => x).join(', ');
                                document.getElementById('sunLocationInfo').value = locationStr + ' (GPS)';
                                document.getElementById('sunLocationDisplay').style.display = 'block';
                            }
                        } catch (err) {
                            console.error('Reverse geocoding error:', err);
                        }

                        button.textContent = 'Location Found!';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 2000);
                    },
                    async (error) => {
                        // GPS failed, try IP-based location
                        console.log('GPS failed, trying IP geolocation...');
                        await fallbackToIPLocation('sun', button, originalText);
                    }
                );
            } else {
                // No geolocation support, use IP fallback
                await fallbackToIPLocation('sun', button, originalText);
            }
        }

        // IP-based geolocation fallback
        async function fallbackToIPLocation(type, button, originalText) {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();

                if (data.latitude && data.longitude) {
                    const lat = parseFloat(data.latitude).toFixed(4);
                    const lon = parseFloat(data.longitude).toFixed(4);

                    if (type === 'uv') {
                        document.getElementById('uvLat').value = lat;
                        const locationStr = [data.city, data.region, data.country_name].filter(x => x).join(', ');
                        document.getElementById('uvLocationInfo').value = locationStr + ' (IP)';
                        document.getElementById('uvLocationDisplay').style.display = 'block';
                    } else if (type === 'sun') {
                        document.getElementById('sunLat').value = lat;
                        document.getElementById('sunLon').value = lon;
                        const locationStr = [data.city, data.region, data.country_name].filter(x => x).join(', ');
                        document.getElementById('sunLocationInfo').value = locationStr + ' (IP)';
                        document.getElementById('sunLocationDisplay').style.display = 'block';
                    } else if (type === 'current') {
                        document.getElementById('currentLat').value = lat;
                        document.getElementById('currentLon').value = lon;
                        const locationStr = [data.city, data.region, data.country_name].filter(x => x).join(', ');
                        document.getElementById('currentLocationInfo').value = locationStr + ' (IP)';
                        document.getElementById('currentLocationDisplay').style.display = 'block';
                    }

                    button.textContent = 'Location Found (IP)!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Unable to determine location from IP');
                }
            } catch (err) {
                console.error('IP geolocation error:', err);
                alert('Unable to determine your location. Please enter coordinates manually.');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-tools-dropdown')) {
                const dropdown = document.getElementById('toolsDropdown');
                if (dropdown) {
                    dropdown.classList.remove('active');
                }
            }
        });

        // Mobile menu toggle
        const menuToggle = document.querySelector('.menu-toggle');
        const toolsDropdown = document.querySelector('.nav-tools-dropdown');

        if (menuToggle && toolsDropdown) {
            menuToggle.addEventListener('click', () => {
                toolsDropdown.classList.toggle('active');
            });
        }

        // Set default dates to today
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('uvDate').value = today;
            document.getElementById('sunDate').value = today;
            document.getElementById('moonDate').value = today;
        });
    </script>
</body>
</html>
